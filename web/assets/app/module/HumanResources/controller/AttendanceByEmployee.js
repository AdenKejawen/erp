Ext.define("Com.GatotKaca.ERP.module.HumanResources.controller.AttendanceByEmployee",{extend:"Com.GatotKaca.ERP.controller.Base",views:["Com.GatotKaca.ERP.module.HumanResources.view.AttendanceByEmployee"],store:"Com.GatotKaca.ERP.module.HumanResources.store.AttendanceByEmployee",fmSelector:"formattendancebyemployee",startDate:"attByEmployeeFilterFrom",endDate:"attByEmployeeFilterTo",init:function(){var b=this;var a=b.getStore(b.store);a.addListener("load",b.onStoreLoad,b);b.loadStore(a);b.getStore("Com.GatotKaca.ERP.store.Reason");b.getStore("Com.GatotKaca.ERP.store.Hour");b.getStore("Com.GatotKaca.ERP.store.Minute");b.getStore("Com.GatotKaca.ERP.module.HumanResources.store.AttendanceDetail");b.getStore("Com.GatotKaca.ERP.module.HumanResources.store.UploadAttendance");b.control({tabupload:{tabchange:b.onTabChange},"gridattendancebyemployee textfield[action=search]":{keypress:b.searchEmployee},"gridattendancebyemployee button[action=refresh]":{click:b.reloadStore},gridattendancebyemployee:{itemclick:b.gridSelect},gridattendancedetail:{itemclick:b.viewDetail},"gridattendancedetail button[action=preview]":{click:b.preview},"gridattendancedetail button[action=pdf]":{click:b.exportPDF},"gridattendancedetail button[action=xls]":{click:b.exportXLS},"gridattendancedetail button[action=image]":{click:b.exportJPG},"gridattendancedetail datefield[name=attByEmployeeFilterFrom]":{change:b.filter},"gridattendancedetail datefield[name=attByEmployeeFilterTo]":{change:b.filter},"gridupload button[action=refresh]":{click:b.reloadUploadStore},"gridupload button[action=procces]":{click:b.proccesAttendance},"gridupload button[action=upload]":{click:b.formUploadAttendance},"formattendancebyemployee button[action=save]":{click:b.saveAttendance},"formattendancebyemployee button[action=reset]":{click:b.resetForm},"formattendancebyemployee checkboxfield[action=change]":{change:b.setAbsence},"formuploadattendance button[action=save]":{click:b.uploadAttendance}});b.callParent(arguments)},onTabChange:function(b,a,d,c){this.loadStore(a.getStore())},searchEmployee:function(d,a,c){var b=this;if(a.ENTER==a.getKey()){b.loadStore(b.store,{query:d.getValue()})}},reloadStore:function(b,a,c){this.loadStore(this.store)},gridSelect:function(d,c,g,a,b,f){var e=this.getForm(this.fmSelector);e.reset();e.findField("employee_id").setValue(c.data.employee_id);this.doFilter(e.findField("employee_id").getValue(),FILTER_START,FILTER_END)},viewDetail:function(d,c,h,a,b,g){var f=this;var e=f.getForm(f.fmSelector);f.ajaxRequest(BASE_URL+"human_resources/attendance/viewdetail",{att_id:c.data.att_id},function(i){var k=i.data[0].att_in.split(":");var j=i.data[0].att_out.split(":");var l=e.findField("att_date");e.setValues(i.data[0]);l.setReadOnly(true);e.findField("att_in_h").setValue(k[0]);e.findField("att_in_m").setValue(k[1]);e.findField("att_out_h").setValue(j[0]);e.findField("att_out_m").setValue(j[1]);f.setReadOnly(false)})},preview:function(b,a,d){var c=this;c.exportValid(b.up("form").getForm(),function(g,f,e){c.ajaxRequest(BASE_URL+"human_resources/attendance/preview",{from:g,to:f,employee_id:e},function(h){c.showWindow({html:h.data},"Print Preview","70%","90%","icon-page_white_magnify")})})},exportPDF:function(b,a,c){this.exportValid(b.up("form").getForm(),function(f,e,d){window.open(BASE_URL+"human_resources/attendance/export/pdf/"+f+"/"+e+"/"+d)})},exportXLS:function(b,a,c){this.exportValid(b.up("form").getForm(),function(f,e,d){window.open(BASE_URL+"human_resources/attendance/export/excel/"+f+"/"+e+"/"+d)})},exportJPG:function(b,a,c){this.exportValid(b.up("form").getForm(),function(f,e,d){window.open(BASE_URL+"human_resources/attendance/export/jpg/"+f+"/"+e+"/"+d)})},filter:function(b,a,e){var d=this;var c=b.up("form").getForm();var f=c.findField("employee_id").getValue();var h=Ext.Date.format(Ext.getCmp(d.startDate).getValue(),DATE_FORMAT);var g=Ext.Date.format(Ext.getCmp(d.endDate).getValue(),DATE_FORMAT);if(f!=""){if(h!=""&&g!=""){d.doFilter(f,h,g)}}},reloadUploadStore:function(b,a,c){this.loadStore("Com.GatotKaca.ERP.module.HumanResources.store.UploadAttendance")},formUploadAttendance:function(b,a,e){var d=this;var c="Com.GatotKaca.ERP.module.HumanResources.view.forms.UploadAttendance";Ext.syncRequire(c,function(){d.showWindow({xtype:"formuploadattendance"},"Upload Attendance","40%","33%","icon-clock_add")})},proccesAttendance:function(b,a,d){var c=this;c.showMessage({title:"NOTIFICATION MESSAGE",msg:"Are you sure to procces attendance?",icon:Ext.MessageBox.WARNING,buttons:Ext.MessageBox.YESNO},function(g,e,f){if(g=="yes"){c.ajaxRequest(BASE_URL+"human_resources/attendance/procces",{},function(h){c.showMessage({title:"MESSAGE",msg:h.msg,icon:Ext.MessageBox.INFO,buttons:Ext.MessageBox.OK});c.reloadUploadStore()})}})},saveAttendance:function(b,a,e){var d=this;var c=d.getForm(d.fmSelector);if(c.isValid()){d.ajaxRequest(BASE_URL+"human_resources/attendance/save",{attendance:Ext.JSON.encode(c.getValues())},function(f){d.showMessage({title:"SERVER MESSAGE",msg:f.msg,icon:Ext.MessageBox.INFO,buttons:Ext.MessageBox.OK});d.doFilter(c.findField("employee_id").getValue(),FILTER_START,FILTER_END);d.resetForm()})}else{d.showMessage({title:"ERROR MESSAGE",msg:"Form is not valid",icon:Ext.MessageBox.WARNING,buttons:Ext.MessageBox.OK})}},resetForm:function(d,b,f){var e=this.getForm(this.fmSelector);var c=e.findField("employee_id");var a=c.getValue();e.reset();e.findField("att_date").setReadOnly(false);c.setValue(a);this.doFilter(e.findField("employee_id").getValue(),FILTER_START,FILTER_END)},setAbsence:function(e,b,a,d){var c=this.getForm(this.fmSelector);if(b){c.findField("att_in_h").setValue("00");c.findField("att_in_m").setValue("00");c.findField("att_out_h").setValue("00");c.findField("att_out_m").setValue("00");c.findField("miss").setValue("SKIP")}this.setReadOnly(b)},uploadAttendance:function(c,a,f){var e=this;var b=c.up("form");var d=b.getForm();if(d.isValid()){d.submit({url:BASE_URL+"human_resources/attendance/upload",waitMsg:"Uploading Attendance...",success:function(g,j){var i="Upload "+j.result.filename+" is success";var h=Ext.MessageBox.INFO;if(!j.result.status){var i="Upload is fail. Check your file (max 2 MB, ext *.csv)";var h=Ext.MessageBox.ERROR}e.showMessage({title:"MESSAGE",msg:i,icon:h,buttons:Ext.MessageBox.OK});b.up("window").close();e.getStore("Com.GatotKaca.ERP.module.HumanResources.store.UploadAttendance").removeAll();e.reloadUploadStore()}})}},setReadOnly:function(b){var a=this.getForm(this.fmSelector);a.findField("att_in_h").setReadOnly(b);a.findField("att_in_m").setReadOnly(b);a.findField("att_out_h").setReadOnly(b);a.findField("att_out_m").setReadOnly(b);a.findField("miss").setReadOnly(b)},exportValid:function(c,f){var b=this;var a=c.findField("employee_id").getValue();if(a!=""){var e=Ext.Date.format(Ext.getCmp(b.startDate).getValue(),DATE_FORMAT);var d=Ext.Date.format(Ext.getCmp(b.endDate).getValue(),DATE_FORMAT);if(e==""){e=FILTER_START;d=FILTER_END}if(f&&typeof(f)==="function"){f(e,d,a)}}else{b.showMessage({title:"ERROR MESSAGE",msg:"Employee must be selected",icon:Ext.MessageBox.WARNING,buttons:Ext.MessageBox.OK})}},doFilter:function(a,c,b){this.loadStore("Com.GatotKaca.ERP.module.HumanResources.store.AttendanceDetail",{employee_id:a,from:c,to:b})}});