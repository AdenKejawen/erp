Ext.define("GatotKacaErp.module.HumanResources.controller.AttendanceByEmployee",{extend:"GatotKacaErp.controller.Base",views:["GatotKacaErp.module.HumanResources.view.AttendanceByEmployee"],store:"GatotKacaErp.module.HumanResources.store.AttendanceByEmployee",fmSelector:"formattendancebyemployee",init:function(){var b=this;var a=b.getStore(b.store);a.addListener("load",b.onStoreLoad,b);b.loadStore(a);b.getStore("GatotKacaErp.store.Reason");b.getStore("GatotKacaErp.store.Hour");b.getStore("GatotKacaErp.store.Minute");b.getStore("GatotKacaErp.module.HumanResources.store.AttendanceDetail");b.getStore("GatotKacaErp.module.HumanResources.store.UploadAttendance");b.control({tabupload:{tabchange:b.onTabChange},"gridattendancebyemployee textfield[action=search]":{keypress:b.searchEmployee},"gridattendancebyemployee button[action=refresh]":{click:b.reloadStore},gridattendancebyemployee:{select:b.gridSelect},gridattendancedetail:{select:b.viewDetail},"gridattendancedetail button[action=preview]":{click:b.preview},"gridattendancedetail button[action=pdf]":{click:b.exportPDF},"gridattendancedetail button[action=xls]":{click:b.exportXLS},"gridattendancedetail button[action=image]":{click:b.exportJPG},"gridattendancedetail datefield[name=attByEmployeeFilterFrom]":{change:b.filter},"gridattendancedetail datefield[name=attByEmployeeFilterTo]":{change:b.filter},"gridupload button[action=refresh]":{click:b.reloadUploadStore},"gridupload button[action=procces]":{click:b.proccesAttendance},"gridupload button[action=upload]":{click:b.formUploadAttendance},"formattendancebyemployee button[action=save]":{click:b.saveAttendance},"formattendancebyemployee button[action=reset]":{click:b.resetForm},"formattendancebyemployee checkboxfield[action=change]":{change:b.setAbsence},"formuploadattendance button[action=save]":{click:b.uploadAttendance}});b.callParent(arguments)},onTabChange:function(b,a,d,c){this.loadStore(a.getStore())},searchEmployee:function(d,a,c){var b=this;if(a.ENTER==a.getKey()){b.loadStore(b.store,{query:d.getValue()})}},reloadStore:function(b,a,c){this.loadStore(this.store)},gridSelect:function(b,e,j,h,i,a){var c=this.getForm(this.fmSelector);c.reset();c.findField("employee_id").setValue(e.data.employee_id);var d=new Date();var g=new Date(d.getFullYear(),d.getMonth(),1);var f=new Date(d.getFullYear(),d.getMonth()+1,0);this.doFilter(c.findField("employee_id").getValue(),g,f)},viewDetail:function(d,c,h,a,b,g){var f=this;var e=f.getForm(f.fmSelector);f.ajaxRequest(BASE_URL+"human_resources/attendance/viewdetail",{att_id:c.data.att_id},function(i){var k=i.data[0].att_in.split(":");var j=i.data[0].att_out.split(":");var l=e.findField("att_date");e.setValues(i.data[0]);l.setReadOnly(true);e.findField("att_in_h").setValue(k[0]);e.findField("att_in_m").setValue(k[1]);e.findField("att_out_h").setValue(j[0]);e.findField("att_out_m").setValue(j[1]);f.setReadOnly(false)})},preview:function(b,a,d){var c=this;c.exportValid(b.up("form").getForm(),function(g,f,e){c.ajaxRequest(BASE_URL+"human_resources/attendance/preview",{from:g,to:f,employee_id:e},function(h){c.showWindow({html:h.data},"Print Preview","70%","90%","icon-page_white_magnify")})})},exportPDF:function(b,a,c){this.exportValid(b.up("form").getForm(),function(f,e,d){window.open(BASE_URL+"human_resources/attendance/export/pdf/"+d+"/"+f+"/"+e)})},exportXLS:function(b,a,c){this.exportValid(b.up("form").getForm(),function(f,e,d){window.open(BASE_URL+"human_resources/attendance/export/excel/"+d+"/"+f+"/"+e)})},exportJPG:function(b,a,c){this.exportValid(b.up("form").getForm(),function(f,e,d){window.open(BASE_URL+"human_resources/attendance/export/jpg/"+d+"/"+f+"/"+e)})},filter:function(b,a,e){var d=this;var c=b.up("form").getForm();var f=c.findField("employee_id").getValue();var h=Ext.Date.format(Ext.getCmp("attByEmployeeFilterFrom").getValue(),"Y-m-d");var g=Ext.Date.format(Ext.getCmp("attByEmployeeFilterTo").getValue(),"Y-m-d");if(f!=""){if(h!=""&&g!=""){d.doFilter(f,h,g)}}},reloadUploadStore:function(b,a,c){this.loadStore("GatotKacaErp.module.HumanResources.store.UploadAttendance")},formUploadAttendance:function(b,a,e){var d=this;var c="GatotKacaErp.module.HumanResources.view.forms.UploadAttendance";Ext.syncRequire(c,function(){d.showWindow({xtype:"formuploadattendance"},"Upload Attendance","40%","33%","icon-clock_add")})},proccesAttendance:function(b,a,d){var c=this;c.showMessage({title:"NOTIFICATION MESSAGE",msg:"Are you sure to procces attendance?",icon:Ext.MessageBox.WARNING,buttons:Ext.MessageBox.YESNO},function(g,e,f){if(g=="yes"){c.ajaxRequest(BASE_URL+"human_resources/attendance/procces",{},function(h){c.showMessage({title:"MESSAGE",msg:h.msg,icon:Ext.MessageBox.INFO,buttons:Ext.MessageBox.OK});c.reloadUploadStore()})}})},saveAttendance:function(b,a,e){var d=this;var c=d.getForm(d.fmSelector);if(c.isValid()){d.ajaxRequest(BASE_URL+"human_resources/attendance/save",{attendance:Ext.JSON.encode(c.getValues())},function(f){d.showMessage({title:"SERVER MESSAGE",msg:f.msg,icon:Ext.MessageBox.INFO,buttons:Ext.MessageBox.OK});var g=new Date();var i=new Date(g.getFullYear(),g.getMonth(),1);var h=new Date(g.getFullYear(),g.getMonth()+1,0);d.doFilter(c.findField("employee_id").getValue(),i,h);d.resetForm()})}else{d.showMessage({title:"ERROR MESSAGE",msg:"Form is not valid",icon:Ext.MessageBox.WARNING,buttons:Ext.MessageBox.OK})}},resetForm:function(c,g,a){var b=this.getForm(this.fmSelector);var h=b.findField("employee_id");var i=h.getValue();b.reset();b.findField("att_date").setReadOnly(false);h.setValue(i);var d=new Date();var f=new Date(d.getFullYear(),d.getMonth(),1);var e=new Date(d.getFullYear(),d.getMonth()+1,0);this.doFilter(b.findField("employee_id").getValue(),f,e)},setAbsence:function(e,b,a,d){var c=this.getForm(this.fmSelector);if(b){c.findField("att_in_h").setValue("00");c.findField("att_in_m").setValue("00");c.findField("att_out_h").setValue("00");c.findField("att_out_m").setValue("00");c.findField("miss").setValue("SKIP")}this.setReadOnly(b)},uploadAttendance:function(c,a,f){var e=this;var b=c.up("form");var d=b.getForm();if(d.isValid()){d.submit({url:BASE_URL+"human_resources/attendance/upload",waitMsg:"Uploading Attendance...",success:function(g,j){var i="Upload "+j.result.filename+" is success";var h=Ext.MessageBox.INFO;if(!j.result.status){var i="Upload is fail. Check your file (max 2 MB, ext *.csv)";var h=Ext.MessageBox.ERROR}e.showMessage({title:"MESSAGE",msg:i,icon:h,buttons:Ext.MessageBox.OK});b.up("window").close();e.loadStore("GatotKacaErp.module.HumanResources.store.UploadAttendance")},errors:function(){}})}},setReadOnly:function(b){var a=this.getForm(this.fmSelector);a.findField("att_in_h").setReadOnly(b);a.findField("att_in_m").setReadOnly(b);a.findField("att_out_h").setReadOnly(b);a.findField("att_out_m").setReadOnly(b);a.findField("miss").setReadOnly(b)},exportValid:function(d,g){var c=this;var b=d.findField("employee_id").getValue();if(b!=""){var f=Ext.Date.format(Ext.getCmp("attByEmployeeFilterFrom").getValue(),"Y-m-d");var e=Ext.Date.format(Ext.getCmp("attByEmployeeFilterTo").getValue(),"Y-m-d");if(f==""){var a=new Date();f=new Date(a.getFullYear(),a.getMonth(),1);e=new Date(a.getFullYear(),a.getMonth()+1,0)}if(g&&typeof(g)==="function"){g(f,e,b)}}else{c.showMessage({title:"ERROR MESSAGE",msg:"Employee must be selected",icon:Ext.MessageBox.WARNING,buttons:Ext.MessageBox.OK})}},doFilter:function(a,c,b){this.loadStore("GatotKacaErp.module.HumanResources.store.AttendanceDetail",{employee_id:a,from:c,to:b})}});