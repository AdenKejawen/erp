Ext.define("GatotKacaErp.module.HumanResources.controller.Employee",{extend:"GatotKacaErp.controller.Base",views:["GatotKacaErp.module.HumanResources.view.Employee"],store:"GatotKacaErp.module.HumanResources.store.Employee",fmSelector:"formemployee",init:function(){var b=this;var a=b.getStore(b.store);b.getStore("GatotKacaErp.module.HumanResources.store.Qualification");b.getStore("GatotKacaErp.module.HumanResources.store.Family");b.getStore("GatotKacaErp.module.HumanResources.store.Experience");b.getStore("GatotKacaErp.module.HumanResources.store.Training");a.addListener("load",b.onStoreLoad,b);b.loadStore(a);b.getStore("GatotKacaErp.store.Company").load();b.getStore("GatotKacaErp.store.OfficeHour").load();b.getStore("GatotKacaErp.store.Religion").load();b.getStore("GatotKacaErp.store.Country").load();b.getStore("GatotKacaErp.store.Education").load();b.getStore("GatotKacaErp.store.JobTitle").load();b.getStore("GatotKacaErp.store.JobStatus").load();b.getStore("GatotKacaErp.store.Family");b.getStore("GatotKacaErp.store.Year");b.getStore("GatotKacaErp.store.Department");b.getStore("GatotKacaErp.store.Gender");b.getStore("GatotKacaErp.store.Province");b.getStore("GatotKacaErp.store.District");b.getStore("GatotKacaErp.store.BODPlace");b.getStore("GatotKacaErp.store.EducationCity");b.getStore("GatotKacaErp.store.TrainingCity");b.getStore("GatotKacaErp.store.BloodType");b.getStore("GatotKacaErp.store.MaritalStatus");b.getStore("GatotKacaErp.store.Employee");b.control({"gridemployee textfield[action=search]":{keypress:b.search},"gridemployee button[action=refresh]":{click:b.reloadStore},gridemployee:{select:b.viewDetail},"formemployee combo[action=company]":{select:b.selectedCompany},"formemployee combo[action=country]":{select:b.selectedCountry},"formemployee combo[action=citizen]":{select:b.selectedCitizen},"formemployee combo[action=province]":{select:b.selectedProvince},"formemployee combo[action=district]":{keydown:b.setDistrictEmp},"formemployee combo[action=status]":{select:b.selectedStatus},"formemployee combo[action=jobtitle]":{select:b.selectedJobtitle},"formemployee button[action=save]":{click:b.save},"formemployee button[action=reset]":{click:b.resetForm},tabemployee:{tabchange:b.loadTab},"formqualification button[action=save]":{click:b.saveEducation},"formqualification button[action=reset]":{click:b.resetEducation},"formqualification combo[action=district]":{keydown:b.setDistrictEdu},gridqualification:{select:b.viewEducation},"formfamily button[action=save]":{click:b.saveFamily},"formfamily button[action=reset]":{click:b.resetFamily},gridfamily:{select:b.viewFamily},"formexperience button[action=save]":{click:b.saveExperience},"formexperience button[action=reset]":{click:b.resetExperience},gridexperience:{select:b.viewExperience},"formtraining button[action=save]":{click:b.saveTraining},"formtraining button[action=reset]":{click:b.resetTraining},gridtraining:{select:b.viewTraining}});b.callParent(arguments)},viewEducation:function(d,c,h,a,b,g){var f=this;var e=f.getForm("formqualification");f.ajaxRequest(BASE_URL+"human_resources/employee/geteducationbyid",{education_id:c.data.education_id},function(i){e.setValues(i.data[0]);f.getDistrictById("GatotKacaErp.store.EducationCity",i.data[0].education_district,function(){e.findField("education_district").setValue(i.data[0].education_district)})})},viewFamily:function(d,c,h,a,b,g){var f=this;var e=f.getForm("formfamily");f.ajaxRequest(BASE_URL+"human_resources/employee/getfamilybyid",{family_id:c.data.family_id},function(i){e.setValues(i.data[0])})},viewExperience:function(d,c,h,a,b,g){var f=this;var e=f.getForm("formexperience");f.ajaxRequest(BASE_URL+"human_resources/employee/getexperiencebyid",{experience_id:c.data.experience_id},function(i){e.setValues(i.data[0])})},viewTraining:function(d,c,h,a,b,g){var f=this;var e=f.getForm("formtraining");f.ajaxRequest(BASE_URL+"human_resources/employee/gettrainingbyid",{training_id:c.data.training_id},function(i){e.setValues(i.data[0]);f.loadStore("GatotKacaErp.store.TrainingCity",{query:i.data[0].training_district},function(j){e.findField("training_district").setValue(j.data[0].district_id)})})},search:function(d,a,c){var b=this;if(a.ENTER==a.getKey()){b.loadStore(b.store,{query:d.getValue()})}},reloadStore:function(){this.loadStore(this.store)},viewDetail:function(d,c,h,a,b,g){var f=this;var e=f.getForm(f.fmSelector);f.ajaxRequest(BASE_URL+"human_resources/employee/getbyid",{employee_id:c.data.employee_id},function(i){Ext.getCmp("employee_photo").getEl().dom.src=PROFILEPATH+i.data[0].employee_photo;e.setValues(i.data[0]);var k=f.activeTab("tabemployee");if(k.store!==undefined){f.loadStoreInfo(k.store,i.data[0].employee_id)}f.disabled(true);f.getDepartmentByCompany(i.data[0].employee_company,i.data[0].employee_department);f.getDistrictById("GatotKacaErp.store.BODPlace",i.data[0].employee_bodplace,function(){e.findField("employee_bodplace").setValue(i.data[0].employee_bodplace)});f.getEmployeeByJobTitle(i.data[0].employee_jobtitle,i.data[0].employee_supervisor);f.getProvinceByCountry(i.data[0].employee_country,i.data[0].employee_paddress);f.getDistrictByProvince(i.data[0].employee_paddress,i.data[0].employee_daddress);f.selectEmployee(i.data[0].employee_id);var j="Until";if(i.data[0].employee_ispermenent){j="Promote"}f.selectStatus(j)})},saveEducation:function(b,a,e){var d=this;var c=b.up("form").getForm();if(c.isValid()){d.ajaxRequest(BASE_URL+"human_resources/employee/saveeducation",{education:Ext.JSON.encode(c.getValues())},function(f){d.showMessage({title:"SERVER MESSAGE",msg:f.msg,icon:Ext.MessageBox.INFO,buttons:Ext.MessageBox.OK});d.resetEducation(b,a,e)})}else{d.showMessage({title:"ERROR MESSAGE",msg:"Form is not valid",icon:Ext.MessageBox.WARNING,buttons:Ext.MessageBox.OK})}},resetEducation:function(b,a,c){this.setDistrictEdu();this.resetFormInfo(b,a,c)},setDistrictEdu:function(){this.resetProxyDistrict("GatotKacaErp.store.EducationCity")},saveFamily:function(b,a,e){var d=this;var c=b.up("form").getForm();if(c.isValid()){d.ajaxRequest(BASE_URL+"human_resources/employee/savefamily",{family:Ext.JSON.encode(c.getValues())},function(f){d.showMessage({title:"SERVER MESSAGE",msg:f.msg,icon:Ext.MessageBox.INFO,buttons:Ext.MessageBox.OK});d.resetFamily(b,a,e)})}else{d.showMessage({title:"ERROR MESSAGE",msg:"Form is not valid",icon:Ext.MessageBox.WARNING,buttons:Ext.MessageBox.OK})}},resetFamily:function(b,a,c){this.resetFormInfo(b,a,c)},saveExperience:function(b,a,e){var d=this;var c=b.up("form").getForm();if(c.isValid()){d.ajaxRequest(BASE_URL+"human_resources/employee/saveexperience",{experience:Ext.JSON.encode(c.getValues())},function(f){d.showMessage({title:"SERVER MESSAGE",msg:f.msg,icon:Ext.MessageBox.INFO,buttons:Ext.MessageBox.OK});d.resetEducation(b,a,e)})}else{d.showMessage({title:"ERROR MESSAGE",msg:"Form is not valid",icon:Ext.MessageBox.WARNING,buttons:Ext.MessageBox.OK})}},resetExperience:function(b,a,c){this.resetFormInfo(b,a,c)},saveTraining:function(b,a,e){var d=this;var c=b.up("form").getForm();if(c.isValid()){d.ajaxRequest(BASE_URL+"human_resources/employee/savetraining",{training:Ext.JSON.encode(c.getValues())},function(f){d.showMessage({title:"SERVER MESSAGE",msg:f.msg,icon:Ext.MessageBox.INFO,buttons:Ext.MessageBox.OK});d.resetEducation(b,a,e)})}else{d.showMessage({title:"ERROR MESSAGE",msg:"Form is not valid",icon:Ext.MessageBox.WARNING,buttons:Ext.MessageBox.OK})}},resetTraining:function(b,a,c){this.resetFormInfo(b,a,c)},selectedCompany:function(d,a,b){var c=this.getForm(this.fmSelector).findField("employee_code");c.setValue(a[0].data.company_code+".");c.focus();this.getDepartmentByCompany(a[0].data.company_id)},selectedCountry:function(c,a,b){this.getProvinceByCountry(a[0].data.country_id)},selectedCitizen:function(c,a,b){var d=this.getForm(this.fmSelector).findField("employee_country");d.setValue(a[0].data.country_id);this.getProvinceByCountry(a[0].data.country_id)},selectedProvince:function(c,a,b){this.getDistrictByProvince(a[0].data.province_id)},selectedJobtitle:function(d,a,b){var c=this.getForm(this.fmSelector).findField("employee_supervisor");this.setLevel(a[0].data.level);this.getEmployeeByJobTitle(a[0].data.jobtitle_id)},selectedStatus:function(d,a,c){var b="Until";if(a[0].data.jobstatus_ispermanent){b="Promote"}this.selectStatus(b)},setDistrictEmp:function(){this.resetProxyDistrict("GatotKacaErp.store.BODPlace")},save:function(c,a,f){var e=this;var d=c.up("form").getForm();var g=d.findField("employee_supervisor");var b=e.getStore("GatotKacaErp.store.JobTitle");b=b.findRecord("jobtitle_id",d.findField("employee_jobtitle").getValue());b=b.data;if(b.level!==1){g.allowBlank=false;g.validateValue(g.getValue())}if(d.isValid()){d.submit({url:BASE_URL+"human_resources/employee/save",waitMsg:"Saving Employee...",submitEmptyText:false,success:function(h,k){var j=k.result.msg;var i=Ext.MessageBox.INFO;if(!k.result.success){var j="Upload is fail. Check your file (max 2 MB, image only)";var i=Ext.MessageBox.ERROR}e.showMessage({title:"MESSAGE",msg:j,icon:i,buttons:Ext.MessageBox.OK});e.reloadStore();e.resetForm()}})}else{e.showMessage({title:"ERROR MESSAGE",msg:"Form is not valid",icon:Ext.MessageBox.WARNING,buttons:Ext.MessageBox.OK})}},resetForm:function(){this.setDistrictEmp();this.getForm(this.fmSelector).reset();this.selectEmployee(null);this.selectStatus("Until");this.disabled(false);Ext.getCmp("employee_photo").getEl().dom.src=DEFAULT_PROFILE},loadTab:function(c,a,f,b){var d=this;var e=a.getForm().findField("employee_id").getValue();if(a.id!=this.fmSelector){if(e!=""){if(a.store!==undefined){d.loadStoreInfo(a.store,e)}}else{c.setActiveTab(f);d.showMessage({title:"ERROR MESSAGE",msg:"Employee must be selected",icon:Ext.MessageBox.WARNING,buttons:Ext.MessageBox.OK})}}},disabled:function(b){var a=this.getForm(this.fmSelector);a.findField("employee_code").setReadOnly(b);a.findField("employee_company").setReadOnly(b);a.findField("employee_department").setReadOnly(b);a.findField("employee_start").setReadOnly(b);a.findField("employee_username").setReadOnly(b);a.findField("employee_jobtitle").setReadOnly(b);a.findField("employee_supervisor").setReadOnly(b);a.findField("employee_jobstatus").setReadOnly(b);a.findField("employee_end").setReadOnly(b)},getDepartmentByCompany:function(a,c){var d=this;var b=d.getStore("GatotKacaErp.store.Department");b.setProxy({type:"ajax",api:{read:BASE_URL+"department/getbycompany"},actionMethods:{read:"POST"},reader:{type:"json",root:"data",successProperty:"success"}});d.loadStore(b,{company_id:a},function(){d.getForm(d.fmSelector).findField("employee_department").setValue(c)})},getProvinceByCountry:function(c,a){var b=this;b.loadStore("GatotKacaErp.store.Province",{country_id:c},function(){b.getForm(b.fmSelector).findField("employee_province").setValue(a)})},getDistrictByProvince:function(a,c){var b=this;b.loadStore("GatotKacaErp.store.District",{province_id:a},function(){b.getForm(b.fmSelector).findField("employee_disctrict").setValue(c)})},getEmployeeByJobTitle:function(a,b){var c=this;c.loadStore("GatotKacaErp.store.Employee",{jobtitle_id:a},function(){var d=c.getForm(c.fmSelector).findField("employee_supervisor");d.setValue(b)})},getDistrictById:function(a,c,d){var a=Ext.getStore(a);var b=this;a.setProxy({type:"ajax",api:{read:BASE_URL+"district/getbyid"},actionMethods:{read:"POST"},reader:{type:"json",root:"data",successProperty:"success"}});b.loadStore(a,{district_id:c},function(){if(d&&typeof(d)==="function"){d()}})},selectEmployee:function(a){this.getForm(this.fmSelector).findField("employee_id").setValue(a);this.getForm("formqualification").findField("employee_id").setValue(a);this.getForm("formfamily").findField("employee_id").setValue(a);this.getForm("formexperience").findField("employee_id").setValue(a);this.getForm("formtraining").findField("employee_id").setValue(a)},selectStatus:function(a){this.getForm(this.fmSelector).findField("employee_end").setFieldLabel(REQUIRED+a)},loadStoreInfo:function(a,b){this.loadStore(a,{employee_id:b})},resetFormInfo:function(c,a,f){var e=c.up("form");var b=e.store;e=e.getForm();var d=e.findField("employee_id").getValue();this.loadStoreInfo(b,d);e.reset();e.findField("employee_id").setValue(d)},resetProxyDistrict:function(a){this.resetProxy(a,BASE_URL+"district/getall")},setLevel:function(b){var a=this.getForm(this.fmSelector).findField("employee_supervisor");if(b===1){a.setValue(null);a.setReadOnly(true);a.allowBlank=true}else{a.setReadOnly(false);a.allowBlank=false}}});