Ext.define("Ext.ux.DataView.Animated",{defaults:{duration:750,idProperty:"id"},constructor:function(a){Ext.apply(this,a||{},this.defaults)},init:function(a){this.dataview=a;var b=a.store;a.blockRefresh=true;a.updateIndexes=Ext.Function.createSequence(a.updateIndexes,function(){this.getTargetEl().select(this.itemSelector).each(function(e,f,d){e.id=e.dom.id=Ext.util.Format.format("{0}-{1}",a.id,b.getAt(d).internalId)},this)},a);this.dataviewID=a.id;this.cachedStoreData={};this.cacheStoreData(b.data||b.snapshot);a.on("resize",function(){var d=a.store;if(d.getCount()>0){}},this);a.store.on("datachanged",c,this);function c(n){var k=a.getTargetEl(),g=n.getAt(0),p=this.getAdded(n),x=this.getRemoved(n),h=this.getRemaining(n);if(!k){return}if(Ext.isIEQuirks){k.applyStyles({zoom:1,display:"block",position:"relative"})}Ext.each(x,function(A){var B=this.dataviewID+"-"+A.internalId;Ext.fly(B).animate({remove:false,duration:d,opacity:0,useDisplay:true,callback:function(){Ext.fly(B).setDisplayed(false)}})},this);if(g==undefined){this.cacheStoreData(n);return}this.cacheStoreData(n);var f=Ext.get(this.dataviewID+"-"+g.internalId);if(!f){a.refresh();return true}var j=f.getMargin("lr")+f.getWidth(),v=f.getMargin("bt")+f.getHeight(),r=k.dom.clientWidth,e=Math.floor(r/j),l=this.dataview.getHierarchyState().rtl,q=l?"right":"left",u;var i={},z={},s={};Ext.iterate(h,function(C,B){var C=B.internalId,A=s[C]=Ext.get(this.dataviewID+"-"+C);i[C]={top:A.getY()-k.getY()-A.getMargin("t")-k.getPadding("t")};i[C][q]=this.getItemX(A)},this);Ext.iterate(h,function(D,C){var A=i[D],B=s[D];if(B.getStyle("position")!="absolute"){u={position:"absolute",top:A.top+"px"};u[q]=A[q]+"px";s[D].applyStyles(u)}});var o=0;Ext.iterate(n.data.items,function(B){var F=B.internalId,A=o%e,E=Math.floor(o/e),D=E*v,C=A*j;z[F]={top:D};z[F][q]=C;o++},this);var t=new Date(),d=this.duration,m=this.dataviewID;var y=function(){var J=new Date()-t,L=J/d,A;if(L>=1){for(A in z){u={top:z[A].top+"px"};u[q]=z[A][q]+"px";Ext.fly(m+"-"+A).applyStyles(u)}Ext.TaskManager.stop(w)}else{for(A in z){if(!h[A]){continue}var D=i[A],G=z[A],E=D.top,H=G.top,C=D[q],I=G[q],F=L*Math.abs(E-H),K=L*Math.abs(C-I),M=E>H?E-F:E+F,B=C>I?C-K:C+K;u={top:M+"px"};u[q]=B+"px";Ext.fly(m+"-"+A).applyStyles(u).setDisplayed(true)}}};var w={run:y,interval:20,scope:this};Ext.TaskManager.start(w);Ext.iterate(p,function(B,A){u={top:z[A.internalId].top+"px"};u[q]=z[A.internalId][q]+"px";Ext.fly(this.dataviewID+"-"+A.internalId).applyStyles(u).setDisplayed(true);Ext.fly(this.dataviewID+"-"+A.internalId).animate({remove:false,duration:d,opacity:1})},this);this.cacheStoreData(n)}},getItemX:function(b){var c=this.dataview.getHierarchyState().rtl,a=b.up("");if(c){return a.getViewRegion().right-b.getRegion().right+b.getMargin("r")}else{return b.getX()-a.getX()-b.getMargin("l")-a.getPadding("l")}},cacheStoreData:function(a){this.cachedStoreData={};a.each(function(b){this.cachedStoreData[b.internalId]=b},this)},getExisting:function(){return this.cachedStoreData},getExistingCount:function(){var c=0,b=this.getExisting();for(var a in b){c++}return c},getAdded:function(a){var b={};a.each(function(c){if(this.cachedStoreData[c.internalId]==undefined){b[c.internalId]=c}},this);return b},getRemoved:function(a){var b=[],c;for(c in this.cachedStoreData){if(a.findBy(function(d){return d.internalId==c})==-1){b.push(this.cachedStoreData[c])}}return b},getRemaining:function(a){var b={};a.each(function(c){if(this.cachedStoreData[c.internalId]!=undefined){b[c.internalId]=c}},this);return b}});