Ext.define("Ext.ux.event.Player",{extend:"Ext.ux.event.Driver",keyFrameEvents:{click:true},pauseForAnimations:true,speed:1,stallTime:0,tagPathRegEx:/(\w+)(?:\[(\d+)\])?/,constructor:function(a){var b=this;b.callParent(arguments);b.addEvents("beforeplay","keyframe");b.eventObject=new Ext.EventObjectImpl();b.timerFn=function(){b.onTick()};b.attachTo=b.attachTo||window},getElementFromXPath:function(h){var j=this,e=h.split("/"),k=j.tagPathRegEx,f,c,d,g,l,b,a=j.attachTo.document;a=(e[0]=="~")?a.body:a.getElementById(e[0].substring(1));for(f=1,c=e.length;a&&f<c;++f){d=k.exec(e[f]);g=d[2]?parseInt(d[2],10):1;l=d[1].toUpperCase();for(b=a.firstChild;b;b=b.nextSibling){if(b.tagName==l){if(g==1){break}--g}}a=b}return a},getTimeIndex:function(){var a=this.getTimestamp()-this.stallTime;return a*this.speed},makeToken:function(a,d){var b=this,c;a[d]=true;a.defer=function(){a[d]=false;c=b.getTime()};a.finish=function(){a[d]=true;b.stallTime+=b.getTime()-c;b.schedule()}},nextEvent:function(b){var c=this,a=++c.queueIndex;if(c.keyFrameEvents[b.type]){Ext.Array.insert(c.eventQueue,a,[{keyframe:true,ts:b.ts}])}},peekEvent:function(){var f=this,a=f.eventQueue,b=f.queueIndex,d=a[b],e=d&&d.type,c;if(e=="mduclick"){c=[Ext.applyIf({type:"mousedown"},d),Ext.applyIf({type:"mouseup"},d),Ext.applyIf({type:"click"},d)];f.replaceEvent(b,c)}return a[b]||null},replaceEvent:function(a,d){for(var c,b=0,e=d.length;b<e;++b){if(b){c=d[b-1];delete c.afterplay;delete c.screenshot;delete d[b].beforeplay}}Ext.Array.replace(this.eventQueue,a,1,d)},processEvents:function(){var b=this,c=b.pauseForAnimations&&b.attachTo.Ext.fx.Manager.items,a;while((a=b.peekEvent())!==null){if(c&&c.getCount()){return true}if(a.keyframe){if(!b.processKeyFrame(a)){return false}b.nextEvent(a)}else{if(a.ts<=b.getTimeIndex()&&b.fireEvent("beforeplay",b,a)!==false&&b.playEvent(a)){if(window.__x&&a.screenshot){__x.poll.sendSyncRequest({cmd:"screenshot"})}b.nextEvent(a)}else{return true}}}b.stop();return false},processKeyFrame:function(a){var b=this;if(!a.defer){b.makeToken(a,"done");b.fireEvent("keyframe",b,a)}return a.done},injectEvent:function(b,a){a.injectEvent(b)},playEvent:function(a){var c=this,d=c.getElementFromXPath(a.target),b;if(!d){return false}if(!c.playEventHook(a,"beforeplay")){return false}if(!a.injected){a.injected=true;b=c.translateEvent(a,d);c.injectEvent(d,b)}return c.playEventHook(a,"afterplay")},playEventHook:function(c,b){var d=this,a=b+".done",f=b+".fired",e=c[b];if(e&&!c[a]){if(!c[f]){c[f]=true;d.makeToken(c,a);d.eventScope[e](c)}return false}return true},schedule:function(){var a=this;if(!a.timer){a.timer=setTimeout(a.timerFn,10)}},translateEvent:function(a,e){var c=this,b=c.eventObject,f=a.modKeys||"",d;if("x" in a){b.xy=d=Ext.fly(e).getXY();d[0]+=a.x;d[1]+=a.y}if("wheel" in a){}b.type=a.type;b.button=a.button;b.altKey=f.indexOf("A")>0;b.ctrlKey=f.indexOf("C")>0;b.metaKey=f.indexOf("M")>0;b.shiftKey=f.indexOf("S")>0;return b},onStart:function(){var a=this;a.queueIndex=0;a.schedule()},onStop:function(){var a=this;if(a.timer){clearTimeout(a.timer);a.timer=null}if(window.__x){__x.poll.sendSyncRequest({cmd:"finish"})}},onTick:function(){var a=this;a.timer=null;if(a.processEvents()){a.schedule()}}});