Ext.define("Ext.ux.panel.PDF",{extend:"Ext.panel.Panel",alias:"widget.pdfpanel",extraBaseCls:Ext.baseCSSPrefix+"pdf",extraBodyCls:Ext.baseCSSPrefix+"pdf-body",autoScroll:true,src:"",pageScale:1,disableWorker:true,disableTextLayer:true,loadingMessage:"Loading PDF, please wait...",beforePageText:"Page",afterPageText:"of {0}",firstText:"First Page",prevText:"Previous Page",nextText:"Next Page",lastText:"Last Page",inputItemWidth:30,scaleWidth:60,getPagingItems:function(){var a=this;return[{itemId:"first",tooltip:a.firstText,overflowText:a.firstText,iconCls:Ext.baseCSSPrefix+"tbar-page-first",disabled:true,handler:a.moveFirst,scope:a},{itemId:"prev",tooltip:a.prevText,overflowText:a.prevText,iconCls:Ext.baseCSSPrefix+"tbar-page-prev",disabled:true,handler:a.movePrevious,scope:a},"-",a.beforePageText,{xtype:"numberfield",itemId:"inputItem",name:"inputItem",cls:Ext.baseCSSPrefix+"tbar-page-number",allowDecimals:false,minValue:1,hideTrigger:true,enableKeyEvents:true,keyNavEnabled:false,selectOnFocus:true,submitValue:false,isFormField:false,width:a.inputItemWidth,margins:"-1 2 3 2",disabled:true,listeners:{scope:a,keydown:a.onPagingKeyDown,blur:a.onPagingBlur}},{xtype:"tbtext",itemId:"afterTextItem",text:Ext.String.format(a.afterPageText,1),margins:"0 5 0 0"},"-",{itemId:"next",tooltip:a.nextText,overflowText:a.nextText,iconCls:Ext.baseCSSPrefix+"tbar-page-next",disabled:true,handler:a.moveNext,scope:a},{itemId:"last",tooltip:a.lastText,overflowText:a.lastText,iconCls:Ext.baseCSSPrefix+"tbar-page-last",disabled:true,handler:a.moveLast,scope:a},"->",{itemId:"scaleCombo",xtype:"combobox",editable:false,keyNavEnabled:true,selectOnFocus:false,submitValue:false,isFormField:false,autoSelect:true,disabled:true,width:a.scaleWidth,store:new Ext.data.SimpleStore({id:0,fields:["scale","text"],data:[[0.5,"50%"],[0.75,"75%"],[1,"100%"],[1.25,"125%"],[1.5,"150%"],[2,"200%"]]}),valueField:"scale",displayField:"text",mode:"local",listeners:{scope:a,change:a.onScaleChange,blur:a.onScaleBlur}}]},initComponent:function(){var c=this,e=c.getPagingItems(),b=c.items||[],a=c.dockedItems||[];c.bodyCls=c.bodyCls||"";c.bodyCls+=(" "+c.extraBodyCls);c.cls=c.cls||"";c.cls+=(" "+c.extraBaseCls);PDFJS.disableTextLayer=c.disableTextLayer;a.push({itemId:"pagingToolbar",xtype:"toolbar",dock:"bottom",items:e});c.dockedItems=a;var d="";if(!PDFJS.disableTextLayer){d='<div class="pdf-text-layer"></div>'}b.push({itemId:"pdfPageContainer",xtype:"container",width:"100%",height:"100%",html:'<canvas class="pdf-page-container"></canvas>'+d,listeners:{afterrender:function(){c.pageContainer=this.el.query(".pdf-page-container")[0];c.pageContainer.mozOpaque=true;var f=c.pageContainer.getContext("2d");f.save();f.fillStyle="rgb(255, 255, 255)";f.fillRect(0,0,c.pageContainer.width,c.pageContainer.height);f.restore();if(!PDFJS.disableTextLayer){c.textLayerDiv=this.el.query(".pdf-text-layer")[0]}}}});c.items=b;c.callParent(arguments);c.on("afterrender",function(){c.loader=new Ext.LoadMask(c.child("#pdfPageContainer"),{msg:c.loadingMessage});c.loader.show()},c,{single:true});if(c.disableWorker){PDFJS.disableWorker=true}c.getDocument()},onLoad:function(){var a=this,b;b=a.pdfDoc.numPages===0;a.currentPage=a.currentPage||(b?0:1);a.renderPage(a.currentPage)},renderPage:function(d){var f=this,e=f.child("#pagingToolbar"),g,c,b,a;if(f.isRendering){return}f.isRendering=true;f.currentPage=d;b=f.currentPage;c=f.pdfDoc.numPages;a=Ext.String.format(f.afterPageText,isNaN(c)?1:c);g=c===0;Ext.suspendLayouts();e.child("#afterTextItem").setText(a);e.child("#inputItem").setDisabled(g).setValue(b);e.child("#first").setDisabled(b===1||g);e.child("#prev").setDisabled(b===1||g);e.child("#next").setDisabled(b===c||g);e.child("#last").setDisabled(b===c||g);e.child("#scaleCombo").setDisabled(g).setValue(f.pageScale);f.pdfDoc.getPage(d).then(function(k){var h=k.getViewport(f.pageScale);f.pageContainer.height=h.height;f.pageContainer.width=h.width;var i=f.pageContainer.getContext("2d");i.save();i.fillStyle="rgb(255, 255, 255)";i.fillRect(0,0,f.pageContainer.width,f.pageContainer.height);i.restore();var l=f.textLayerDiv?Ext.create("Ext.ux.util.PDF.TextLayerBuilder",{textLayerDiv:f.textLayerDiv}):null;var j={canvasContext:i,viewport:h,textLayer:l};k.render(j);Ext.resumeLayouts(true);f.isRendering=false;if(f.loader){f.loader.destroy()}if(f.rendered){f.fireEvent("change",f,{current:f.currentPage,total:f.pdfDoc.numPages})}})},moveFirst:function(){var a=this;if(a.fireEvent("beforechange",a,1)!==false){a.renderPage(1)}},movePrevious:function(){var b=this,a=b.currentPage-1;if(a>0){if(b.fireEvent("beforechange",b,a)!==false){b.renderPage(a)}}},moveNext:function(){var c=this,b=c.pdfDoc.numPages,a=c.currentPage+1;if(a<=b){if(c.fireEvent("beforechange",c,a)!==false){c.renderPage(a)}}},moveLast:function(){var b=this,a=b.pdfDoc.numPages;if(b.fireEvent("beforechange",b,a)!==false){b.renderPage(a)}},readPageFromInput:function(){var b=this,a=b.child("#pagingToolbar").child("#inputItem").getValue(),c=parseInt(a,10);if(!a||isNaN(c)){b.child("#pagingToolbar").child("#inputItem").setValue(b.currentPage);return false}return c},onPagingFocus:function(){this.child("#pagingToolbar").child("#inputItem").select()},onPagingBlur:function(b){var a=this.getPageData().currentPage;this.child("#pagingToolbar").child("#inputItem").setValue(a)},onPagingKeyDown:function(h,g){var d=this,b=g.getKey(),a=g.shiftKey?10:1,f,c=d.pdfDoc.numPages;if(b==g.RETURN){g.stopEvent();f=d.readPageFromInput();if(f!==false){f=Math.min(Math.max(1,f),c);if(d.fireEvent("beforechange",d,f)!==false){d.renderPage(f)}}}else{if(b==g.HOME||b==g.END){g.stopEvent();f=b==g.HOME?1:c;h.setValue(f)}else{if(b==g.UP||b==g.PAGE_UP||b==g.DOWN||b==g.PAGE_DOWN){g.stopEvent();f=d.readPageFromInput();if(f){if(b==g.DOWN||b==g.PAGE_DOWN){a*=-1}f+=a;if(f>=1&&f<=c){h.setValue(f)}}}}}},onScaleBlur:function(a){this.child("#pagingToolbar").child("#scaleCombo").setValue(this.pageScale)},onScaleChange:function(c,b){var a=this;a.pageScale=b;a.renderPage(a.currentPage)},setSrc:function(a){this.src=a;return this.getDocument()},getDocument:function(){var a=this;if(!!a.src){PDFJS.getDocument(a.src).then(function(b){a.pdfDoc=b;a.onLoad()})}return a}});