Ext.define("Ext.ux.RowExpander",{extend:"Ext.AbstractPlugin",lockableScope:"normal",requires:["Ext.grid.feature.RowBody","Ext.grid.feature.RowWrap"],alias:"plugin.rowexpander",rowBodyTpl:null,expandOnEnter:true,expandOnDblClick:true,selectRowOnExpand:false,rowBodyTrSelector:".x-grid-rowbody-tr",rowBodyHiddenCls:"x-grid-row-body-hidden",rowCollapsedCls:"x-grid-row-collapsed",addCollapsedCls:{before:function(a,b){var c=this.rowExpander;if(!c.recordsExpanded[a.record.internalId]){a.itemClasses.push(c.rowCollapsedCls)}},priority:500},constructor:function(){var d=this,b,a,c;d.callParent(arguments);b=d.getCmp();d.recordsExpanded={};if(!d.rowBodyTpl){Ext.Error.raise("The 'rowBodyTpl' config is required and is not defined.")}d.rowBodyTpl=Ext.XTemplate.getTpl(d,"rowBodyTpl");a=this.rowBodyTpl;c=[{ftype:"rowbody",lockableScope:"normal",columnId:d.getHeaderId(),recordsExpanded:d.recordsExpanded,rowBodyHiddenCls:d.rowBodyHiddenCls,rowCollapsedCls:d.rowCollapsedCls,setupRowData:d.getRowBodyFeatureData,getRowBodyContents:function(e){return a.applyTemplate(e.getData())}},{ftype:"rowwrap",lockableScope:"normal"}];if(b.features){b.features=Ext.Array.push(c,b.features)}else{b.features=c}},init:function(b){var d=this,a=b,c;d.callParent(arguments);d.grid=b;d.view=b.getView();d.addExpander();d.bindView(d.view);d.view.addRowTpl(d.addCollapsedCls).rowExpander=d;if(b.ownerLockable){a=b.ownerLockable;a.syncRowHeight=false;c=a.lockedGrid.getView();d.bindView(c);c.addRowTpl(d.addCollapsedCls).rowExpander=d;a.mon(a,"columnschanged",d.refreshRowHeights,d);a.mon(a.store,"datachanged",d.refreshRowHeights,d)}a.on("beforereconfigure",d.beforeReconfigure,d)},beforeReconfigure:function(d,a,c,e,b){var f=this.getHeaderConfig();f.locked=true;c.unshift(f)},addExpander:function(){var b=this,a=b.grid,c=b.getHeaderConfig();if(a.ownerLockable){a=a.ownerLockable.lockedGrid;a.width+=c.width}a.headerCt.insert(0,c)},getHeaderId:function(){if(!this.headerId){this.headerId=Ext.id()}return this.headerId},getRowBodyFeatureData:function(b,a,d){var c=this;c.self.prototype.setupRowData.apply(c,arguments);if(!c.grid.ownerLockable){d.rowBodyColspan=d.rowBodyColspan-1}d.rowBody=c.getRowBodyContents(b);d.rowBodyCls=c.recordsExpanded[b.internalId]?"":c.rowBodyHiddenCls},bindView:function(a){if(this.expandOnEnter){a.on("itemkeydown",this.onKeyDown,this)}if(this.expandOnDblClick){a.on("itemdblclick",this.onDblClick,this)}},onKeyDown:function(j,f,k,a,g){if(g.getKey()==g.ENTER){var b=j.store,c=j.getSelectionModel().getSelection(),h=c.length,d=0;for(;d<h;d++){a=b.indexOf(c[d]);this.toggleRow(a,c[d])}}},onDblClick:function(b,a,f,c,d){this.toggleRow(c,a)},toggleRow:function(b,e){var g=this,h=g.view,c=h.getNode(b),j=Ext.fly(c,"_rowExpander"),f=j.down(g.rowBodyTrSelector,true),d=j.hasCls(g.rowCollapsedCls),i=d?"removeCls":"addCls",a;Ext.suspendLayouts();j[i](g.rowCollapsedCls);Ext.fly(f)[i](g.rowBodyHiddenCls);g.recordsExpanded[e.internalId]=d;h.refreshSize();h.fireEvent(d?"expandbody":"collapsebody",j.dom,e,f);if(g.grid.ownerLockable){h=g.grid.ownerLockable.lockedGrid.view;a=j.getHeight();j=Ext.fly(h.getNode(b),"_rowExpander");j.setHeight(a);j[i](g.rowCollapsedCls);h.refreshSize()}Ext.resumeLayouts(true)},refreshRowHeights:function(){Ext.globalEvents.on({idle:this.doRefreshRowHeights,scope:this,single:true})},doRefreshRowHeights:function(){var g=this,i=g.recordsExpanded,h,e,j=g.grid.ownerLockable.lockedGrid.view,a=g.grid.ownerLockable.normalGrid.view,c,d,f,b;for(h in i){e=this.view.store.data.get(h);d=j.getNode(e,false);c=a.getNode(e,false);d.style.height=c.style.height="";f=d.offsetHeight;b=c.offsetHeight;if(b>f){d.style.height=b+"px"}else{if(f>b){c.style.height=f+"px"}}}},getHeaderConfig:function(){var a=this;return{id:a.getHeaderId(),width:24,lockable:false,sortable:false,resizable:false,draggable:false,hideable:false,menuDisabled:true,cls:Ext.baseCSSPrefix+"grid-header-special",renderer:function(c,b){b.tdCls=Ext.baseCSSPrefix+"grid-cell-special";b.tdAttr='valign="top"';if(!a.grid.ownerLockable){b.tdAttr+=' rowspan="2"'}return'<div class="'+Ext.baseCSSPrefix+'grid-row-expander">&#160;</div>'},processEvent:function(g,d,b,i,f,h,c){if(g=="mousedown"&&h.getTarget(".x-grid-row-expander")){a.toggleRow(i,c);return a.selectRowOnExpand}}}}});