Ext.define("Ext.tree.ViewDropZone",{extend:"Ext.view.DropZone",allowParentInserts:false,allowContainerDrops:false,appendOnly:false,expandDelay:500,indicatorCls:Ext.baseCSSPrefix+"tree-ddindicator",expandNode:function(b){var a=this.view;this.expandProcId=false;if(!b.isLeaf()&&!b.isExpanded()){a.expand(b);this.expandProcId=false}},queueExpand:function(a){this.expandProcId=Ext.Function.defer(this.expandNode,this.expandDelay,this,[a])},cancelExpand:function(){if(this.expandProcId){clearTimeout(this.expandProcId);this.expandProcId=false}},getPosition:function(f,b){var i=this.view,c=i.getRecord(b),g=f.getPageY(),j=c.isLeaf(),a=false,h=Ext.fly(b).getRegion(),d;if(c.isRoot()){return"append"}if(this.appendOnly){return j?false:"append"}if(!this.allowParentInserts){a=c.hasChildNodes()&&c.isExpanded()}d=(h.bottom-h.top)/(j?2:3);if(g>=h.top&&g<(h.top+d)){return"before"}else{if(!a&&(j||(g>=(h.bottom-d)&&g<=h.bottom))){return"after"}else{return"append"}}},isValidDropPoint:function(b,h,m,j,f){if(!b||!f.item){return false}var n=this.view,k=n.getRecord(b),d=f.records,a=d.length,l=d.length,c,g;if(!(k&&h&&a)){return false}for(c=0;c<l;c++){g=d[c];if(g.isNode&&g.contains(k)){return false}}if(h==="append"&&k.get("allowDrop")===false){return false}else{if(h!="append"&&k.parentNode.get("allowDrop")===false){return false}}if(Ext.Array.contains(d,k)){return false}return n.fireEvent("nodedragover",k,h,f,j)!==false},onNodeOver:function(a,h,f,c){var d=this.getPosition(f,a),b=this.dropNotAllowed,i=this.view,g=i.getRecord(a),j=this.getIndicator(),k=0;this.cancelExpand();if(d=="append"&&!this.expandProcId&&!Ext.Array.contains(c.records,g)&&!g.isLeaf()&&!g.isExpanded()){this.queueExpand(g)}if(this.isValidDropPoint(a,d,h,f,c)){this.valid=true;this.currentPosition=d;this.overRecord=g;j.setWidth(Ext.fly(a).getWidth());k=Ext.fly(a).getY()-Ext.fly(i.el).getY()-1;if(d=="before"){b=g.isFirst()?Ext.baseCSSPrefix+"tree-drop-ok-above":Ext.baseCSSPrefix+"tree-drop-ok-between";j.showAt(0,k);h.proxy.show()}else{if(d=="after"){b=g.isLast()?Ext.baseCSSPrefix+"tree-drop-ok-below":Ext.baseCSSPrefix+"tree-drop-ok-between";k+=Ext.fly(a).getHeight();j.showAt(0,k);h.proxy.show()}else{b=Ext.baseCSSPrefix+"tree-drop-ok-append";j.hide()}}}else{this.valid=false}this.currentCls=b;return b},onNodeOut:function(d,a,c,b){this.valid=false;this.getIndicator().hide()},onContainerOver:function(a,c,b){return c.getTarget("."+this.indicatorCls)?this.currentCls:this.dropNotAllowed},notifyOut:function(){this.callParent(arguments);this.cancelExpand()},handleNodeDrop:function(e,l,g){var n=this,o=n.view,h=l?l.parentNode:o.panel.getRootNode(),a=o.getStore().treeStore.model,b,d,k,f,c,j,m,p;if(e.copy){b=e.records;e.records=[];for(d=0,k=b.length;d<k;d++){f=b[d];if(f.isNode){e.records.push(f.copy(undefined,true))}else{e.records.push(new a(f[f.persistenceProperty],f.getId()))}}}n.cancelExpand();if(g=="before"){c=h.insertBefore;j=[null,l];l=h}else{if(g=="after"){if(l.nextSibling){c=h.insertBefore;j=[null,l.nextSibling]}else{c=h.appendChild;j=[null]}l=h}else{if(!(l.isExpanded()||l.isLoading())){m=true}c=l.appendChild;j=[null]}}p=function(){var i,q;for(d=0,k=e.records.length;d<k;d++){j[0]=e.records[d];c.apply(l,j)}if(n.sortOnDrop){l.sort(l.getOwnerTree().store.generateComparator())}if(Ext.enableFx&&n.dropHighlight){i=n.dropHighlightColor;for(d=0;d<k;d++){q=o.getNode(e.records[d]);if(q){Ext.fly(q).highlight(i)}}}};if(m){l.expand(false,p)}else{p()}}});