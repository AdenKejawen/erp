Ext.define("Ext.direct.RemotingProvider",{extend:"Ext.direct.JsonProvider",alias:"direct.remotingprovider",requires:["Ext.util.MixedCollection","Ext.util.DelayedTask","Ext.direct.Transaction","Ext.direct.RemotingMethod"],enableBuffer:10,maxRetries:1,constructor:function(a){var b=this;b.callParent(arguments);b.addEvents("beforecall","call","beforecallback");b.namespace=(Ext.isString(b.namespace))?Ext.ns(b.namespace):b.namespace||Ext.global;b.transactions=new Ext.util.MixedCollection();b.callBuffer=[]},getNamespace:function(b,e){var f,d,c,a;b=b||Ext.global;f=e.toString().split(".");for(c=0,a=f.length;c<a;c++){d=f[c];b=b[d];if(typeof b==="undefined"){return b}}return b},createNamespaces:function(b,e){var f,d;b=b||Ext.global;f=e.toString().split(".");for(var c=0,a=f.length;c<a;c++){d=f[c];b[d]=b[d]||{};b=b[d]}return b},initAPI:function(){var h=this,e=h.actions,c=h.namespace,d,j,b,f,g,a;for(d in e){if(e.hasOwnProperty(d)){if(h.disableNestedActions){j=c[d];if(!j){j=c[d]={}}}else{j=h.getNamespace(c,d);if(!j){j=h.createNamespaces(c,d)}}b=e[d];for(f=0,g=b.length;f<g;++f){a=new Ext.direct.RemotingMethod(b[f]);j[a.name]=h.createHandler(d,a)}}}},createHandler:function(c,e){var b=this,d=Array.prototype.slice,a;if(!e.formHandler){a=function(){b.configureRequest(c,e,d.call(arguments,0))}}else{a=function(g,h,f){b.configureFormRequest(c,e,g,h,f)}}a.directCfg={action:c,method:e};return a},isConnected:function(){return !!this.connected},connect:function(){var a=this;if(a.url){a.initAPI();a.connected=true;a.fireEvent("connect",a)}else{if(!a.url){Ext.Error.raise('Error initializing RemotingProvider "'+a.id+'", no url configured.')}}},disconnect:function(){var a=this;if(a.connected){a.connected=false;a.fireEvent("disconnect",a)}},runCallback:function(f,c){var e=!!c.status,d=e?"success":"failure",g,b,a;if(f&&f.callback){g=f.callback;b=f.callbackOptions;a=typeof c.result!=="undefined"?c.result:c.data;if(Ext.isFunction(g)){g(a,c,e,b)}else{Ext.callback(g[d],g.scope,[a,c,e,b]);Ext.callback(g.callback,g.scope,[a,c,e,b])}}},onData:function(k,h,c){var f=this,d,e,j,a,b,g;if(h){j=f.createEvents(c);for(d=0,e=j.length;d<e;++d){a=j[d];b=f.getTransaction(a);f.fireEvent("data",f,a);if(b&&f.fireEvent("beforecallback",f,a,b)!==false){f.runCallback(b,a,true);Ext.direct.Manager.removeTransaction(b)}}}else{g=[].concat(k.transaction);for(d=0,e=g.length;d<e;++d){b=f.getTransaction(g[d]);if(b&&b.retryCount<f.maxRetries){b.retry()}else{a=new Ext.direct.ExceptionEvent({data:null,transaction:b,code:Ext.direct.Manager.exceptions.TRANSPORT,message:"Unable to connect to the server.",xhr:c});f.fireEvent("data",f,a);if(b&&f.fireEvent("beforecallback",f,b)!==false){f.runCallback(b,a,false);Ext.direct.Manager.removeTransaction(b)}}}}},getTransaction:function(a){return a&&a.tid?Ext.direct.Manager.getTransaction(a.tid):null},configureRequest:function(f,b,h){var i=this,d,g,j,k,a,c,e;d=b.getCallData(h);g=d.data;j=d.callback;k=d.scope;a=d.options||{};e=Ext.apply({},{provider:i,args:h,action:f,method:b.name,data:g,callbackOptions:a,callback:k&&Ext.isFunction(j)?Ext.Function.bind(j,k):j});if(a.timeout){Ext.applyIf(e,{timeout:a.timeout})}c=new Ext.direct.Transaction(e);if(i.fireEvent("beforecall",i,c,b)!==false){Ext.direct.Manager.addTransaction(c);i.queueTransaction(c);i.fireEvent("call",i,c,b)}},getCallData:function(a){return{action:a.action,method:a.method,data:a.data,type:"rpc",tid:a.id}},sendRequest:function(g){var f=this,e,b,h,d=f.enableUrlEncode,c,a;e={url:f.url,callback:f.onData,scope:f,transaction:g,timeout:f.timeout};if(g.timeout){e.timeout=g.timeout}if(Ext.isArray(g)){b=[];for(c=0,a=g.length;c<a;++c){b.push(f.getCallData(g[c]))}}else{b=f.getCallData(g)}if(d){h={};h[Ext.isString(d)?d:"data"]=Ext.encode(b);e.params=h}else{e.jsonData=b}Ext.Ajax.request(e)},queueTransaction:function(c){var b=this,a=b.enableBuffer;if(c.form){b.sendFormRequest(c);return}if(a===false||typeof c.timeout!=="undefined"){b.sendRequest(c);return}b.callBuffer.push(c);if(a){if(!b.callTask){b.callTask=new Ext.util.DelayedTask(b.combineAndSend,b)}b.callTask.delay(Ext.isNumber(a)?a:10)}else{b.combineAndSend()}},combineAndSend:function(){var c=this,b=c.callBuffer,a=b.length;if(a>0){c.sendRequest(a==1?b[0]:b);c.callBuffer=[]}},configureFormRequest:function(e,a,b,h,i){var g=this,c,f,d;c=new Ext.direct.Transaction({provider:g,action:e,method:a.name,args:[b,h,i],callback:i&&Ext.isFunction(h)?Ext.Function.bind(h,i):h,isForm:true});if(g.fireEvent("beforecall",g,c,a)!==false){Ext.direct.Manager.addTransaction(c);f=String(b.getAttribute("enctype")).toLowerCase()=="multipart/form-data";d={extTID:c.id,extAction:e,extMethod:a.name,extType:"rpc",extUpload:String(f)};Ext.apply(c,{form:Ext.getDom(b),isUpload:f,params:h&&Ext.isObject(h.params)?Ext.apply(d,h.params):d});g.fireEvent("call",g,c,a);g.sendFormRequest(c)}},sendFormRequest:function(b){var a=this;Ext.Ajax.request({url:a.url,params:b.params,callback:a.onData,scope:a,form:b.form,isUpload:b.isUpload,transaction:b})}});