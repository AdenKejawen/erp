Ext.define("Ext.data.proxy.WebStorage",{extend:"Ext.data.proxy.Client",alternateClassName:"Ext.data.WebStorageProxy",requires:["Ext.data.SequentialIdGenerator"],id:undefined,constructor:function(a){this.callParent(arguments);this.cache={};if(this.getStorageObject()===undefined){Ext.Error.raise("Local Storage is not supported in this browser, please use another type of data proxy")}this.id=this.id||(this.store?this.store.storeId:undefined);if(this.id===undefined){Ext.Error.raise("No unique id was provided to the local storage proxy. See Ext.data.proxy.LocalStorage documentation for details")}this.initialize()},create:function(e,j,k){var h=this,d=e.records,c=d.length,a=h.getIds(),b,g,f;e.setStarted();if(h.isHierarchical===undefined){h.isHierarchical=!!d[0].isNode;if(h.isHierarchical){h.getStorageObject().setItem(h.getTreeKey(),true)}}for(f=0;f<c;f++){g=d[f];if(g.phantom){g.phantom=false;b=h.getNextId()}else{b=g.getId()}h.setRecord(g,b);g.commit();a.push(b)}h.setIds(a);e.setCompleted();e.setSuccessful();if(typeof j=="function"){j.call(k||h,e)}},read:function(f,l,n){var k=this,e=[],h=0,m=true,d=k.model,a,c,j,g,b;f.setStarted();if(k.isHierarchical){e=k.getTreeData()}else{a=k.getIds();c=a.length;b=f.id;if(b){g=k.getRecord(b);if(g!==null){j=new d(g,b,g)}if(j){e.push(j)}else{m=false}}else{for(;h<c;h++){b=a[h];g=k.getRecord(b);e.push(new d(g,b,g))}}}if(m){f.setSuccessful()}f.setCompleted();f.resultSet=Ext.create("Ext.data.ResultSet",{records:e,total:e.length,loaded:true});if(typeof l=="function"){l.call(n||k,f)}},update:function(e,h,j){var d=e.records,c=d.length,a=this.getIds(),g,b,f;e.setStarted();for(f=0;f<c;f++){g=d[f];this.setRecord(g);g.commit();b=g.getId();if(b!==undefined&&Ext.Array.indexOf(a,b)==-1){a.push(b)}}this.setIds(a);e.setCompleted();e.setSuccessful();if(typeof h=="function"){h.call(j||this,e)}},destroy:function(d,j,k){var f=this,c=d.records,a=f.getIds(),g=a.length,l=[],h={},e=c.length,b;d.setStarted();for(;e--;){Ext.apply(h,f.removeRecord(c[e]))}for(e=0;e<g;e++){b=a[e];if(!h[b]){l.push(b)}}f.setIds(l);d.setCompleted();d.setSuccessful();if(typeof j=="function"){j.call(k||f,d)}},getRecord:function(d){var b=this,a=b.cache,c=!a[d]?Ext.decode(b.getStorageObject().getItem(b.getRecordKey(d))):a[d];if(!c){return null}a[d]=c;c[b.model.prototype.idProperty]=d;return c},setRecord:function(j,c){if(c){j.setId(c)}else{c=j.getId()}var l=this,a=j.data,g={},h=l.model,k=h.prototype.fields.items,d=k.length,f=0,m,b,e,n;for(;f<d;f++){m=k[f];b=m.name;if(m.persist){g[b]=a[b]}}delete g[l.model.prototype.idProperty];if(j.isNode&&j.get("depth")===1){delete g.parentId}e=l.getStorageObject();n=l.getRecordKey(c);l.cache[c]=g;e.removeItem(n);e.setItem(n,Ext.encode(g))},removeRecord:function(a){var d=this,f=a.getId(),b={},c,e;b[f]=a;d.getStorageObject().removeItem(d.getRecordKey(f));delete d.cache[f];if(a.childNodes){e=a.childNodes;for(c=e.length;c--;){Ext.apply(b,d.removeRecord(e[c]))}}return b},getRecordKey:function(a){if(a.isModel){a=a.getId()}return Ext.String.format("{0}-{1}",this.id,a)},getRecordCounterKey:function(){return Ext.String.format("{0}-counter",this.id)},getTreeKey:function(){return Ext.String.format("{0}-tree",this.id)},getIds:function(){var f=this,d=(f.getStorageObject().getItem(f.id)||"").split(","),b=f.model,e=d.length,a=b.prototype.fields.get(b.prototype.idProperty).type.type==="string",c;if(e==1&&d[0]===""){d=[]}else{for(c=0;c<e;c++){d[c]=a?d[c]:+d[c]}}return d},setIds:function(a){var b=this.getStorageObject(),c=a.join(",");b.removeItem(this.id);if(!Ext.isEmpty(c)){b.setItem(this.id,c)}},getNextId:function(){var d=this,e=d.getStorageObject(),c=d.getRecordCounterKey(),b=d.model,a=b.prototype.fields.get(b.prototype.idProperty).type.type==="string",f;f=d.idGenerator.generate();e.setItem(c,f);if(!a){f=+f}return f},getTreeData:function(){var m=this,a=m.getIds(),e=a.length,h=[],b={},n=[],j=0,g=m.model,p=g.prototype.idProperty,f,l,o,k,d,c;for(;j<e;j++){c=a[j];l=m.getRecord(c);h.push(l);b[c]=l;if(!l.parentId){n.push(l)}}f=n.length;Ext.Array.sort(h,m.sortByParentId);for(j=f;j<e;j++){l=h[j];k=l.parentId;if(!o||o[p]!==k){o=b[k];o.children=d=[]}d.push(l)}for(j=e;j--;){l=h[j];if(!l.children&&!l.leaf){l.loaded=true}}for(j=f;j--;){l=n[j];n[j]=new g(l,l[p],l)}return n},sortByParentId:function(b,a){return(b.parentId||0)-(a.parentId||0)},initialize:function(){var b=this,a=b.getStorageObject(),c=+a.getItem(b.getRecordCounterKey());a.setItem(b.id,a.getItem(b.id)||"");if(a.getItem(b.getTreeKey())){b.isHierarchical=true}b.idGenerator=new Ext.data.SequentialIdGenerator({seed:c?c+1:1})},clear:function(){var d=this,e=d.getStorageObject(),c=d.getIds(),a=c.length,b;for(b=0;b<a;b++){e.removeItem(d.getRecordKey(c[b]))}e.removeItem(d.getRecordCounterKey());e.removeItem(d.getTreeKey());e.removeItem(d.id);d.cache={}},getStorageObject:function(){Ext.Error.raise("The getStorageObject function has not been defined in your Ext.data.proxy.WebStorage subclass")}});