Ext.define("Ext.selection.CellModel",{extend:"Ext.selection.Model",alias:"selection.cellmodel",requires:["Ext.grid.CellContext","Ext.util.KeyNav"],isCellModel:true,enableKeyNav:true,preventWrap:false,noSelection:{row:-1,column:-1},constructor:function(){this.addEvents("deselect","select");this.callParent(arguments)},bindComponent:function(a){var c=this,b=a.ownerCt;c.primaryView=a;c.views=c.views||[];c.views.push(a);c.bindStore(a.getStore(),true);a.on({cellmousedown:c.onMouseDown,refresh:c.onViewRefresh,scope:c});if(b.optimizedColumnMove!==false){b.on("columnmove",c.onColumnMove,c)}if(c.enableKeyNav){c.initKeyNav(a)}},initKeyNav:function(a){var b=this;if(!a.rendered){a.on("render",Ext.Function.bind(b.initKeyNav,b,[a],0),b,{single:true});return}a.el.set({tabIndex:-1});b.keyNav=new Ext.util.KeyNav({target:a.el,ignoreInputFields:true,up:b.onKeyUp,down:b.onKeyDown,right:b.onKeyRight,left:b.onKeyLeft,tab:b.onKeyTab,scope:b})},getHeaderCt:function(){var b=this.getCurrentPosition(),a=b?b.view:this.primaryView;return a.headerCt},onKeyUp:function(a){this.doMove("up",a)},onKeyDown:function(a){this.doMove("down",a)},onKeyLeft:function(a){this.doMove("left",a)},onKeyRight:function(a){this.doMove("right",a)},doMove:function(b,a){this.keyNavigation=true;this.move(b,a);this.keyNavigation=false},onVetoUIEvent:Ext.emptyFn,select:function(g,e,b){var d=this,f,c=d.getCurrentPosition(),a=d.view.store;if(g||g===0){if(g.isModel){f=a.indexOf(g);if(f!==-1){g={row:f,column:c?c.column:0}}else{g=null}}else{if(typeof g==="number"){g={row:g,column:0}}}}if(g){d.selectByPosition(g,b)}else{d.deselect()}},deselect:function(a,b){this.selectByPosition(null,b)},move:function(a,d){var c=this,f=c.getCurrentPosition(),b;if(f){b=f.view.walkCells(f,a,d,c.preventWrap);if(b){b.view=f.view;return c.setCurrentPosition(b)}}return null},getCurrentPosition:function(){return this.selecting?this.nextSelection:this.selection},setCurrentPosition:function(d,a){var c=this,b=c.selection;c.lastSelection=b;if(b){if(d&&(d.record===b.record&&d.columnHeader===b.columnHeader&&d.view===b.view)){d=null}else{c.onCellDeselect(c.selection,a)}}if(d){c.nextSelection=new Ext.grid.CellContext(c.primaryView).setPosition(d);c.selecting=true;c.onCellSelect(c.nextSelection,a);c.selecting=false;return(c.selection=c.nextSelection)}return null},isCellSelected:function(a,e,c){var d=this,b,f=d.getCurrentPosition();if(f&&f.view===a){b=new Ext.grid.CellContext(a).setPosition({row:e,column:c});return(b.record===f.record)&&(b.columnHeader===f.columnHeader)}},onStoreRemove:function(j,b,e){var g=this,h=g.getCurrentPosition(),c,a=b.length,f,d=0;g.callParent(arguments);if(h){if(e[0]>h.row){return}for(c=0;c<a;c++){f=e[c];if(f<h.row){d++}else{break}}if(d){h.setRow(h.row-d)}}},onMouseDown:function(c,a,f,b,h,d,g){if(d!==-1){this.setCurrentPosition({view:c,row:h,column:f})}},onCellSelect:function(a,b){if(a&&a.row!==undefined&&a.row>-1){this.doSelect(a.record,false,b)}},onCellDeselect:function(a,b){if(a&&a.row!==undefined){this.doDeselect(a.record,b)}},onSelectChange:function(b,e,d,g){var f=this,h,c,a;if(e){h=f.nextSelection;c="select"}else{h=f.lastSelection||f.noSelection;c="deselect"}a=h.view||f.primaryView;if((d||f.fireEvent("before"+c,f,b,h.row,h.column))!==false&&g()!==false){if(e){a.focusRow(b,true);a.onCellSelect(h)}else{a.onCellDeselect(h);delete f.selection}if(!d){f.fireEvent(c,f,b,h.row,h.column)}}},onKeyTab:function(d,b){var c=this,f=c.getCurrentPosition(),a;if(f){a=f.view.editingPlugin;if(a&&c.wasEditing){c.onEditorTab(a,d)}else{c.move(d.shiftKey?"left":"right",d)}}},onEditorTab:function(b,f){var c=this,d=f.shiftKey?"left":"right",a=c.move(d,f);if(a){if(b.startEdit(a.record,a.columnHeader)){c.wasEditing=false}else{c.wasEditing=true}}},refresh:function(){var b=this.getCurrentPosition(),a;if(b&&(a=this.store.indexOf(this.selected.last()))!==-1){b.row=a}},onColumnMove:function(d,e,b,c){var a=d.up("tablepanel");if(a){this.onViewRefresh(a.view)}},onUpdate:function(a){var b=this,c;if(b.isSelected(a)){c=b.selecting?b.nextSelection:b.selection;b.view.onCellSelect(c)}},onViewRefresh:function(b){var c=this,f=c.getCurrentPosition(),e=b.headerCt,a,d;if(f&&f.view===b){a=f.record;d=f.columnHeader;if(!d.isDescendantOf(e)){d=e.queryById(d.id)||e.down('[text="'+d.text+'"]')||e.down('[dataIndex="'+d.dataIndex+'"]')}if(d&&(b.store.indexOfId(a.getId())!==-1)){c.setCurrentPosition({row:a,column:d,view:b})}}},selectByPosition:function(a,b){this.setCurrentPosition(a,b)}});