Ext.define("Ext.grid.PagingScroller",{percentageFromEdge:0.35,numFromEdge:2,trailingBufferZone:5,leadingBufferZone:15,scrollToLoadBuffer:200,viewSize:0,rowHeight:21,tableStart:0,tableEnd:0,constructor:function(a){var b=this;b.variableRowHeight=a.variableRowHeight;b.bindView(a.view);Ext.apply(b,a);b.callParent(arguments)},bindView:function(b){var f=this,d={scroll:{fn:f.onViewScroll,element:"el",scope:f},render:f.onViewRender,resize:f.onViewResize,boxready:{fn:f.onViewResize,scope:f,single:true},beforerefresh:f.beforeViewRefresh,refresh:f.onViewRefresh,scope:f},a={guaranteedrange:f.onGuaranteedRange,scope:f},c={reconfigure:f.onGridReconfigure,scope:f},e;if(f.view){if(f.view.el){f.view.el.un("scroll",f.onViewScroll,f)}e=b.lockingPartner;if(e){e.un("refresh",f.onLockRefresh,f)}f.view.un(d);f.store.un(a);if(f.grid){f.grid.un(c)}delete f.view.refreshSize}f.view=b;f.grid=f.view.up("tablepanel");f.store=b.store;if(b.rendered){f.viewSize=f.store.viewSize=Math.ceil(b.getHeight()/f.rowHeight)+f.trailingBufferZone+(f.numFromEdge*2)+f.leadingBufferZone}e=b.lockingPartner;if(e){e.on("refresh",f.onLockRefresh,f)}f.view.mon(f.store.pageMap,{scope:f,clear:f.onCacheClear});f.view.refreshSize=Ext.Function.createInterceptor(f.view.refreshSize,f.beforeViewrefreshSize,f);f.position=0;if(f.grid){f.grid.on(c)}else{f.view.on({added:function(){f.grid=f.view.up("tablepanel");f.grid.on(c)},single:true})}f.view.on(f.viewListeners=d);f.store.on(a)},onCacheClear:function(){var a=this;if(a.view.rendered&&!a.store.isDestroyed){a.ignoreNextScrollEvent=a.view.el.dom.scrollTop!==0;a.view.el.dom.scrollTop=0;delete a.lastScrollDirection;delete a.scrollOffset;delete a.scrollProportion}},onGridReconfigure:function(a){this.bindView(a.view)},onViewRender:function(){var d=this,a=d.view,c=d.view.el,b;d.stretcher=d.createStretcher(a);a=a.lockingPartner;if(a){b=d.stretcher;d.stretcher=new Ext.CompositeElement(b);d.stretcher.add(d.createStretcher(a))}},createStretcher:function(a){var b=a.el;b.setStyle("position","relative");return b.createChild({style:{position:"absolute",width:"1px",height:0,top:0,left:0}},b.dom.firstChild)},onViewResize:function(b,d,a){var e=this,c;c=Math.ceil(a/e.rowHeight)+e.trailingBufferZone+(e.numFromEdge*2)+e.leadingBufferZone;if(c>e.viewSize){e.viewSize=e.store.viewSize=c;e.handleViewScroll(e.lastScrollDirection||1)}},beforeViewRefresh:function(){var b=this,a=b.view,c,d;b.focusOnRefresh=Ext.Element.getActiveElement===a.el.dom;if(b.variableRowHeight){d=b.lastScrollDirection;b.commonRecordIndex=undefined;if(d&&(b.previousStart!==undefined)&&(b.scrollProportion===undefined)&&(c=a.getNodes()).length){if(d===1){if(b.tableStart<=b.previousEnd){b.commonRecordIndex=c.length-1}}else{if(d===-1){if(b.tableEnd>=b.previousStart){b.commonRecordIndex=0}}}b.scrollOffset=-a.el.getOffsetsTo(c[b.commonRecordIndex])[1];b.commonRecordIndex-=(b.tableStart-b.previousStart)}else{b.scrollOffset=undefined}}},onLockRefresh:function(a){a.table.dom.style.position="absolute"},onViewRefresh:function(){var d=this,f=d.store,c,e=d.view,i=e.el,j=i.dom,l,h,b,k=e.table.dom,g,a;if(d.focusOnRefresh){i.focus();d.focusOnRefresh=false}d.disabled=true;if(f.getCount()===f.getTotalCount()||(f.isFiltered()&&!f.remoteFilter)){d.stretcher.setHeight(0);d.position=j.scrollTop=0;d.setTablePosition("absolute");return}d.stretcher.setHeight(c=d.getScrollHeight());a=j.scrollTop;d.isScrollRefresh=(a>0);if(d.scrollProportion!==undefined){d.setTablePosition("absolute");d.setTableTop((d.scrollProportion?(c*d.scrollProportion)-(k.offsetHeight*d.scrollProportion):0)+"px")}else{d.setTablePosition("absolute");d.setTableTop((g=(d.tableStart||0)*d.rowHeight)+"px");if(d.scrollOffset){l=e.getNodes();h=-i.getOffsetsTo(l[d.commonRecordIndex])[1];b=h-d.scrollOffset;d.position=(j.scrollTop+=b)}else{if((g>a)||((g+k.offsetHeight)<a+j.clientHeight)){d.lastScrollDirection=-1;d.position=j.scrollTop=g}}}d.disabled=false},setTablePosition:function(a){this.setViewTableStyle(this.view,"position",a)},setTableTop:function(a){this.setViewTableStyle(this.view,"top",a)},setViewTableStyle:function(a,c,b){a.el.child("table",true).style[c]=b;a=a.lockingPartner;if(a){a.el.child("table",true).style[c]=b}},beforeViewrefreshSize:function(){if(this.isScrollRefresh){this.view.table.attach(this.view.el.child("table",true));return(this.isScrollRefresh=false)}},onGuaranteedRange:function(b,e,a){var c=this,d=c.store;if(b.length&&c.visibleStart<b[0].index){return}c.previousStart=c.tableStart;c.previousEnd=c.tableEnd;c.tableStart=e;c.tableEnd=a;d.loadRecords(b,{start:e})},onViewScroll:function(f,c){var d=this,a=d.view,b=d.position;d.position=a.el.dom.scrollTop;if(d.ignoreNextScrollEvent){d.ignoreNextScrollEvent=false;return}if(!d.disabled){d.lastScrollDirection=d.position>b?1:-1;if(b!==d.position){d.handleViewScroll(d.lastScrollDirection)}}},handleViewScroll:function(h){var e=this,j=e.store,g=e.view,f=e.viewSize,k=j.getTotalCount(),d=k-f,c=e.getFirstVisibleRowIndex(),i=e.getLastVisibleRowIndex(),a=g.el.dom,b,l;if(k>=f){e.scrollProportion=undefined;if(h==-1){if(e.tableStart){if(c!==undefined){if(c<(e.tableStart+e.numFromEdge)){b=Math.max(0,i+e.trailingBufferZone-f)}}else{e.scrollProportion=a.scrollTop/(a.scrollHeight-a.clientHeight);b=Math.max(0,k*e.scrollProportion-(f/2)-e.numFromEdge-((e.leadingBufferZone+e.trailingBufferZone)/2))}}}else{if(c!==undefined){if(i>(e.tableEnd-e.numFromEdge)){b=Math.max(0,c-e.trailingBufferZone)}}else{e.scrollProportion=a.scrollTop/(a.scrollHeight-a.clientHeight);b=k*e.scrollProportion-(f/2)-e.numFromEdge-((e.leadingBufferZone+e.trailingBufferZone)/2)}}if(b!==undefined){if(b>d){b=d&~1;l=k-1}else{b=b&~1;l=b+f-1}if(j.rangeCached(b,l)){e.cancelLoad();j.guaranteeRange(b,l)}else{e.attemptLoad(b,l)}}}},getFirstVisibleRowIndex:function(){var d=this,a=d.view,g=a.el.dom.scrollTop,e,c,b,f;if(d.variableRowHeight){e=a.getNodes();c=e.length;if(!c){return}f=Ext.fly(e[0]).getOffsetsTo(a.el)[1];for(b=0;b<c;b++){f+=e[b].offsetHeight;if(f>a.el.dom.clientHeight){return}if(f>0){return a.getRecord(e[b]).index}}}else{return Math.floor(g/d.rowHeight)}},getLastVisibleRowIndex:function(){var g=this,c=g.store,a=g.view,b=a.el.dom.clientHeight,h,f,e,d;if(g.variableRowHeight){h=a.getNodes();if(!h.length){return}f=c.getCount()-1;d=Ext.fly(h[f]).getOffsetsTo(a.el)[1]+h[f].offsetHeight;for(e=f;e>=0;e--){d-=h[e].offsetHeight;if(d<0){return}if(d<b){return a.getRecord(h[e]).index}}}else{return g.getFirstVisibleRowIndex()+Math.ceil(b/g.rowHeight)+1}},getScrollHeight:function(){var e=this,a=e.view,d,g,b=e.store,f=0,c=!e.hasOwnProperty("rowHeight");if(e.variableRowHeight){d=e.view.table.dom;if(c){e.initialTableHeight=d.offsetHeight;e.rowHeight=e.initialTableHeight/e.store.getCount()}else{f=d.offsetHeight-e.initialTableHeight;if(b.getCount()>e.viewSize){f-=e.rowHeight}}}else{if(c){g=a.el.down(a.getItemSelector());if(g){e.rowHeight=g.getHeight(false,true)}}}return Math.floor(b.getTotalCount()*e.rowHeight)+f},attemptLoad:function(c,a){var b=this;if(b.scrollToLoadBuffer){if(!b.loadTask){b.loadTask=new Ext.util.DelayedTask(b.doAttemptLoad,b,[])}b.loadTask.delay(b.scrollToLoadBuffer,b.doAttemptLoad,b,[c,a])}else{b.store.guaranteeRange(c,a)}},cancelLoad:function(){if(this.loadTask){this.loadTask.cancel()}},doAttemptLoad:function(b,a){this.store.guaranteeRange(b,a)},destroy:function(){var b=this,a=b.viewListeners.scroll;b.store.un({guaranteedrange:b.onGuaranteedRange,scope:b});b.view.un(b.viewListeners);if(b.view.rendered){b.stretcher.remove();b.view.el.un("scroll",a.fn,a.scope)}}});