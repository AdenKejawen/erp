Ext.define("Ext.grid.header.DropZone",{extend:"Ext.dd.DropZone",colHeaderCls:Ext.baseCSSPrefix+"column-header",proxyOffsets:[-4,-9],constructor:function(a){this.headerCt=a;this.ddGroup=this.getDDGroup();this.callParent([a.el])},getDDGroup:function(){return"header-dd-zone-"+this.headerCt.up("[scrollerOwner]").id},getTargetFromEvent:function(a){return a.getTarget("."+this.colHeaderCls)},getTopIndicator:function(){if(!this.topIndicator){this.topIndicator=Ext.DomHelper.append(Ext.getBody(),{cls:"col-move-top",html:"&#160;"},true)}return this.topIndicator},getBottomIndicator:function(){if(!this.bottomIndicator){this.bottomIndicator=Ext.DomHelper.append(Ext.getBody(),{cls:"col-move-bottom",html:"&#160;"},true)}return this.bottomIndicator},getLocation:function(d,b){var a=d.getXY()[0],c=Ext.fly(b).getRegion(),f;if((c.right-a)<=(c.right-c.left)/2){f="after"}else{f="before"}return{pos:f,header:Ext.getCmp(b.id),node:b}},positionIndicator:function(z,q,w){var r=z.header,f=this.getLocation(w,q),k=f.header,d=f.pos,p=r.up("headercontainer:not(gridcolumn)"),j=k.up("headercontainer:not(gridcolumn)"),c=r.nextSibling("gridcolumn:not([hidden])"),v=r.previousSibling("gridcolumn:not([hidden])"),m,t,u,a,b,l,n,y,x,o,h,s,g;if(!k.draggable&&d==="before"&&k.getIndex()===0){return false}z.isLock=z.isUnlock=false;if(p!==j&&p.lockableInjected&&j.lockableInjected&&j.lockedCt){z.isLock=true}else{if(p!==j&&p.lockableInjected&&j.lockableInjected&&p.lockedCt){z.isUnlock=true}}if((z.isUnlock&&r.lockable===false)||(z.isLock&&!r.isLockable())){return false}z.dropLocation=f;if((r!==k)&&((d==="before"&&c!==k)||(d==="after"&&v!==k))&&!k.isDescendantOf(r)){o=Ext.dd.DragDropManager.getRelated(this);h=o.length;s=0;for(;s<h;s++){g=o[s];if(g!==this&&g.invalidateDrop){g.invalidateDrop()}}this.valid=true;m=this.getTopIndicator();t=this.getBottomIndicator();if(d==="before"){u="tl";a="bl"}else{u="tr";a="br"}b=k.el.getAnchorXY(u);l=k.el.getAnchorXY(a);n=this.headerCt.el;y=n.getX();x=n.getX()+n.getWidth();b[0]=Ext.Number.constrain(b[0],y,x);l[0]=Ext.Number.constrain(l[0],y,x);b[0]-=4;b[1]-=9;l[0]-=4;m.setXY(b);t.setXY(l);m.show();t.show()}else{this.invalidateDrop()}},invalidateDrop:function(){this.valid=false;this.hideIndicators()},onNodeOver:function(d,a,g,f){var c=this,b=true,i=f.header,h;if(f.header.el.dom===d){b=false}else{h=c.getLocation(g,d).header;b=(i.ownerCt===h.ownerCt)||(!i.ownerCt.sealed&&!h.ownerCt.sealed)}if(b){c.positionIndicator(f,d,g)}else{c.valid=false}return c.valid?c.dropAllowed:c.dropNotAllowed},hideIndicators:function(){this.getTopIndicator().hide();this.getBottomIndicator().hide()},onNodeOut:function(){this.hideIndicators()},onNodeDrop:function(f,n,l,h){if(this.valid){var k=h.header,j=h.dropLocation,b=j.header,p=k.ownerCt,m=p.items.indexOf(k),i=b.ownerCt,r=i.items.indexOf(b),d=this.headerCt,a=d.getHeaderIndex(k),g=k.isGroupHeader?k.query(":not([isGroupHeader])").length:1,q=d.getHeaderIndex(b),o,c;if(j.pos==="after"){r++;q+=b.isGroupHeader?b.query(":not([isGroupHeader])").length:1}if(h.isLock){c=p.up("[scrollerOwner]");c.lock(k,r);h.isLock=false;this.onNodeDrop(f,n,l,h)}else{if(h.isUnlock){c=p.up("[scrollerOwner]");c.unlock(k,r);h.isUnlock=false;this.onNodeDrop(f,n,l,h)}else{this.invalidateDrop();if((p===i)){if(r===m){d.onHeaderMoved(k,g,a,q);return}if(r>m){r-=1}}Ext.suspendLayouts();if(p!==i){p.remove(k,false)}if(p===i){i.move(m,r)}else{i.insert(r,k)}if(i.isGroupHeader){if(i!==p){k.savedFlex=k.flex;delete k.flex;k.width=k.getWidth()}}else{if(k.savedFlex){k.flex=k.savedFlex;delete k.width}}d.purgeCache();Ext.resumeLayouts(true);d.onHeaderMoved(k,g,a,q);if(!p.items.getCount()){p.destroy()}}}}}});