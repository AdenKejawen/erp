Ext.define("Ext.grid.locking.Lockable",{alternateClassName:"Ext.grid.Lockable",requires:["Ext.grid.locking.View","Ext.grid.header.Container","Ext.grid.locking.HeaderContainer","Ext.view.Table"],syncRowHeight:true,headerCounter:0,scrollDelta:40,lockedGridCls:Ext.baseCSSPrefix+"grid-inner-locked",unlockText:"Unlock",lockText:"Lock",bothCfgCopy:["invalidateScrollerOnRefresh","hideHeaders","enableColumnHide","enableColumnMove","enableColumnResize","sortableColumns","columnLines","rowLines"],normalCfgCopy:["verticalScroller","verticalScrollDock","verticalScrollerType","scroll"],lockedCfgCopy:[],determineXTypeToCreate:function(e){var c=this,g,d,b,f,a;if(c.subGridXType){g=c.subGridXType}else{if(!e){return"gridpanel"}d=this.getXTypes().split("/");b=d.length;f=d[b-1];a=d[b-2];if(a!=="tablepanel"){g=a}else{g=f}}return g},injectLockable:function(){this.lockable=true;this.hasView=true;var n=this,a=Ext.getScrollbarSize().height,o=n.store=Ext.StoreManager.lookup(n.store),j=n.getSelectionModel(),k,b,e,l,g,d,c,h,q,f,m,p=n.findPlugin("bufferedrenderer");k=n.constructLockableFeatures();if(n.features){n.features=null}b=n.constructLockablePlugins();n.plugins=b.topPlugins;e=Ext.apply({id:n.id+"-locked",isLocked:true,ownerLockable:n,xtype:n.determineXTypeToCreate(true),store:o,scrollerOwner:false,animate:false,scroll:a?false:"vertical",selModel:j,border:false,cls:n.lockedGridCls,isLayoutRoot:function(){return false},features:k.lockedFeatures,plugins:b.lockedPlugins},n.lockedGridConfig);l=Ext.apply({id:n.id+"-normal",isLocked:false,ownerLockable:n,xtype:n.determineXTypeToCreate(),store:o,scrollerOwner:false,selModel:j,border:false,isLayoutRoot:function(){return false},features:k.normalFeatures,plugins:b.normalPlugins},n.normalGridConfig);n.addCls(Ext.baseCSSPrefix+"grid-locked");Ext.copyTo(l,n,n.bothCfgCopy,true);Ext.copyTo(e,n,n.bothCfgCopy,true);Ext.copyTo(l,n,n.normalCfgCopy,true);Ext.copyTo(e,n,n.lockedCfgCopy,true);for(g=0;g<n.normalCfgCopy.length;g++){delete n[n.normalCfgCopy[g]]}for(g=0;g<n.lockedCfgCopy.length;g++){delete n[n.lockedCfgCopy[g]]}n.addEvents("processcolumns","lockcolumn","unlockcolumn");n.addStateEvents(["lockcolumn","unlockcolumn"]);d=n.processColumns(n.columns);e.width=d.lockedWidth+Ext.num(j.headerWidth,0)+(d.locked.items.length?1:0);e.columns=d.locked;l.columns=d.normal;l.flex=1;e.viewConfig=n.lockedViewConfig||{};e.viewConfig.loadingUseMsg=false;e.viewConfig.loadMask=false;if(a){e.viewConfig.style="border-bottom:"+a+"px solid #f6f6f6;"+(e.viewConfig.style||"")}l.viewConfig=n.normalViewConfig||{};l.viewConfig.loadMask=false;if(n.viewConfig&&n.viewConfig.id){Ext.log.warn('id specified on Lockable viewConfig, it will be shared between both views: "'+n.viewConfig.id+'"')}Ext.applyIf(e.viewConfig,n.viewConfig);Ext.applyIf(l.viewConfig,n.viewConfig);n.lockedGrid=Ext.ComponentManager.create(e);if(n.isTree){n.lockedGrid.getView().animate=false;l.store=n.lockedGrid.view.store;l.deferRowRender=false;l.viewConfig.stripeRows=n.lockedGrid.view.stripeRows;l.rowLines=n.lockedGrid.rowLines}q=n.lockedGrid.getView();l.viewConfig.lockingPartner=q;n.normalGrid=Ext.ComponentManager.create(l);q.lockingPartner=f=n.normalGrid.getView();n.view=new Ext.grid.locking.View({loadingText:f.loadingText,loadingCls:f.loadingCls,loadingUseMsg:f.loadingUseMsg,loadMask:n.loadMask!==false,locked:n.lockedGrid,normal:n.normalGrid,panel:n});m=p?{}:{scroll:{fn:n.onLockedViewScroll,element:"el",scope:n}};if(a){n.lockedGrid.on({afterlayout:n.afterLockedViewLayout,scope:n});q.getOverflowStyle();if(q.scrollFlags.y){n.lockedGrid.headerCt.forceFit=true}else{m.mousewheel={fn:n.onLockedViewMouseWheel,element:"el",scope:n}}}q.on(m);m=p?{}:{scroll:{fn:n.onNormalViewScroll,element:"el",scope:n},scope:n};f.on(m);c=n.lockedGrid.headerCt;h=n.normalGrid.headerCt;n.headerCt=n.view.headerCt=new Ext.grid.locking.HeaderContainer(n);c.lockedCt=true;c.lockableInjected=true;h.lockableInjected=true;c.on({add:{buffer:1,scope:n,fn:n.onLockedHeaderAdd},columnshow:n.onLockedHeaderShow,columnhide:n.onLockedHeaderHide,sortchange:n.onLockedHeaderSortChange,columnresize:n.onLockedHeaderResize,scope:n});h.on({sortchange:n.onNormalHeaderSortChange,scope:n});n.modifyHeaderCt();n.items=[n.lockedGrid,n.normalGrid];n.relayHeaderCtEvents(c);n.relayHeaderCtEvents(h);n.storeRelayers=n.relayEvents(o,["filterchange"]);n.layout={type:"hbox",align:"stretch"}},getLockingViewConfig:function(){return{xclass:"Ext.grid.locking.View",locked:this.lockedGrid,normal:this.normalGrid,panel:this}},processColumns:function(c){var e,g,b,j=this.dummyHdrCtr||(this.self.prototype.dummyHdrCtr=new Ext.grid.header.Container()),h=[],d=[],a={itemId:"lockedHeaderCt",stretchMaxPartner:"^^>>#normalHeaderCt",items:h},f={itemId:"normalHeaderCt",stretchMaxPartner:"^^>>#lockedHeaderCt",items:d},k={lockedWidth:0,locked:a,normal:f};if(Ext.isObject(c)){Ext.applyIf(a,c);Ext.applyIf(f,c);Ext.apply(j,c);c=c.items}for(e=0,g=c.length;e<g;++e){b=c[e];if(!b.isComponent){b=j.lookupComponent(j.applyDefaults(b))}b.processed=true;if(b.locked||b.autoLock){if(!b.hidden){k.lockedWidth+=this.getColumnWidth(b)||j.defaultWidth}h.push(b)}else{d.push(b)}if(!b.headerId){b.headerId=(b.initialConfig||b).id||("h"+(++this.headerCounter))}}this.fireEvent("processcolumns",this,h,d);return k},getColumnWidth:function(e){var b=e.width||0,d,a,c;if(e.flex){Ext.Error.raise("Columns which are locked do NOT support a flex width. You must set a width on the "+e.text+"column.")}if(!b&&e.isGroupHeader){d=e.items.items;a=d.length;for(c=0;c<a;c++){b+=this.getColumnWidth(d[c])}}return b},afterLockedViewLayout:function(){var c=this,b=c.lockedGrid.getView(),a=b.el.dom,d=(c.normalGrid.headerCt.tooNarrow?Ext.getScrollbarSize().height:0);if(b.scrollFlags.x&&a.scrollWidth>a.clientWidth){d=0}b.el.dom.style.borderBottomWidth=d+"px";if(!Ext.isBorderBox){b.el.setHeight(b.lastBox.height)}},onLockedViewMouseWheel:function(h){var d=this,g=-d.scrollDelta,a=g*h.getWheelDeltas().y,b=d.lockedGrid.getView().el.dom,c,f;if(!d.ignoreMousewheel){if(b){c=b.scrollTop!==b.scrollHeight-b.clientHeight;f=b.scrollTop!==0}if((a<0&&f)||(a>0&&c)){h.stopEvent();b.scrollTop+=a;d.normalGrid.getView().el.dom.scrollTop=b.scrollTop;d.onNormalViewScroll()}}},onLockedViewScroll:function(){var e=this,d=e.lockedGrid.getView(),c=e.normalGrid.getView(),g=c.el.dom,f=d.el.dom,a,b;if(g.scrollTop!==f.scrollTop){g.scrollTop=f.scrollTop;if(e.store.buffered){b=d.el.child("table",true);a=c.el.child("table",true);a.style.position="absolute";a.style.top=b.style.top}}},onNormalViewScroll:function(){var e=this,d=e.lockedGrid.getView(),c=e.normalGrid.getView(),g=c.el.dom,f=d.el.dom,a,b;if(g.scrollTop!==f.scrollTop){f.scrollTop=g.scrollTop;if(e.store.buffered){b=d.el.child("table",true);a=c.el.child("table",true);b.style.position="absolute";b.style.top=a.style.top}}},syncRowHeights:function(){var e=this,a,d=e.lockedGrid.getView(),b=e.normalGrid.getView(),f=d.all.slice(),h=b.all.slice(),c=f.length,g;if(h.length===c){for(a=0;a<c;a++){b.syncRowHeights(f[a],h[a])}g=b.el.dom.scrollTop;b.el.dom.scrollTop=g;d.el.dom.scrollTop=g}},modifyHeaderCt:function(){var a=this;a.lockedGrid.headerCt.getMenuItems=a.getMenuItems(a.lockedGrid.headerCt.getMenuItems,true);a.normalGrid.headerCt.getMenuItems=a.getMenuItems(a.normalGrid.headerCt.getMenuItems,false);a.lockedGrid.headerCt.showMenuBy=Ext.Function.createInterceptor(a.lockedGrid.headerCt.showMenuBy,a.showMenuBy);a.normalGrid.headerCt.showMenuBy=Ext.Function.createInterceptor(a.normalGrid.headerCt.showMenuBy,a.showMenuBy)},onUnlockMenuClick:function(){this.unlock()},onLockMenuClick:function(){this.lock()},showMenuBy:function(b,f){var e=this.getMenu(),c=e.down("#unlockItem"),d=e.down("#lockItem"),a=c.prev();if(f.lockable===false){a.hide();c.hide();d.hide()}else{a.show();c.show();d.show();if(!c.initialConfig.disabled){c.setDisabled(f.lockable===false)}if(!d.initialConfig.disabled){d.setDisabled(!f.isLockable())}}},getMenuItems:function(f,c){var g=this,h=g.unlockText,a=g.lockText,i=Ext.baseCSSPrefix+"hmenu-unlock",b=Ext.baseCSSPrefix+"hmenu-lock",e=Ext.Function.bind(g.onUnlockMenuClick,g),d=Ext.Function.bind(g.onLockMenuClick,g);return function(){var j=f.call(this);j.push("-",{itemId:"unlockItem",cls:i,text:h,handler:e,disabled:!c});j.push({itemId:"lockItem",cls:b,text:a,handler:d,disabled:c});return j}},syncLockedWidth:function(){var e=this,b=e.lockedGrid,d=b.view,c=d.el.dom,g=e.normalGrid,f=b.headerCt.getVisibleGridColumns().length,a=g.headerCt.getVisibleGridColumns().length;Ext.suspendLayouts();if(a){g.show();if(f){if(!b.headerCt.forceFit){delete b.flex;b.setWidth(b.headerCt.getFullWidth())}b.addCls(e.lockedGridCls);b.show()}else{b.getView().refresh();b.hide()}d.el.setStyle(d.getOverflowStyle());e.ignoreMousewheel=d.scrollFlags.y}else{g.hide();c.style.borderBottomWidth="0";b.flex=1;delete b.width;b.removeCls(e.lockedGridCls);b.show();d.el.setStyle(g.view.getOverflowStyle());e.ignoreMousewheel=true}Ext.resumeLayouts(true);return[f,a]},onLockedHeaderAdd:function(){if(!this.ignoreAddLockedColumn){this.syncLockedWidth()}},onLockedHeaderResize:function(){this.syncLockedWidth()},onLockedHeaderHide:function(){this.syncLockedWidth()},onLockedHeaderShow:function(){this.syncLockedWidth()},onLockedHeaderSortChange:function(b,c,a){if(a){this.normalGrid.headerCt.clearOtherSortStates(null,true)}},onNormalHeaderSortChange:function(b,c,a){if(a){this.lockedGrid.headerCt.clearOtherSortStates(null,true)}},lock:function(c,i){var e=this,d=e.normalGrid,b=e.lockedGrid,f=d.headerCt,g=b.headerCt,h,a;c=c||f.getMenu().activeHeader;a=c.ownerCt;if(!c.isLockable()){return}if(c.flex){c.width=c.getWidth();c.flex=null}Ext.suspendLayouts();a.remove(c,false);c.locked=true;e.ignoreAddLockedColumn=true;if(Ext.isDefined(i)){g.insert(i,c)}else{g.add(c)}e.ignoreAddLockedColumn=false;h=e.syncLockedWidth();if(h[0]){b.getView().refresh()}if(h[1]){d.getView().refresh()}Ext.resumeLayouts(true);e.fireEvent("lockcolumn",e,c)},unlock:function(b,e){var d=this,f=d.normalGrid,h=d.lockedGrid,g=f.headerCt,c=h.headerCt,a;if(!Ext.isDefined(e)){e=0}b=b||c.getMenu().activeHeader;Ext.suspendLayouts();b.ownerCt.remove(b,false);b.locked=false;g.insert(e,b);a=d.syncLockedWidth();if(a[0]){h.getView().refresh()}if(a[1]){f.getView().refresh()}Ext.resumeLayouts(true);d.fireEvent("unlockcolumn",d,b)},reconfigureLockable:function(a,b){var c=this,f=c.store,e=c.lockedGrid,d=c.normalGrid;Ext.suspendLayouts();if(b){e.headerCt.removeAll();d.headerCt.removeAll();b=c.processColumns(b);c.ignoreAddLockedColumn=true;e.headerCt.add(b.locked.items);c.ignoreAddLockedColumn=false;d.headerCt.add(b.normal.items);c.syncLockedWidth()}if(a&&a!==f){a=Ext.data.StoreManager.lookup(a);c.store=a;e.bindStore(a);d.bindStore(a)}else{e.getView().refresh();d.getView().refresh()}Ext.resumeLayouts(true)},constructLockableFeatures:function(){var e=this.features,c,d,f,g,b=0,a;if(e){f=[];g=[];a=e.length;for(;b<a;b++){c=e[b];if(!c.isFeature){c=Ext.create("feature."+c.ftype,c)}switch(c.lockableScope){case"locked":f.push(c);break;case"normal":g.push(c);break;default:c.lockableScope="both";f.push(c);g.push(d=c.clone());d.lockingPartner=c;c.lockingPartner=d}}}return{normalFeatures:g,lockedFeatures:f}},constructLockablePlugins:function(){var c=this.plugins,f,b,a,h,j,d,e=0,g;if(c){h=[];j=[];d=[];g=c.length;for(;e<g;e++){f=c[e];switch(f.lockableScope){case"both":j.push(a=f.clonePlugin());d.push(b=f.clonePlugin());a.lockingPartner=b;b.lockingPartner=a;Ext.destroy(f);break;case"locked":j.push(f);break;case"normal":d.push(f);break;default:h.push(f)}}}return{topPlugins:h,normalPlugins:d,lockedPlugins:j}},destroyLockable:function(){Ext.destroy(this.view)}},function(){this.borrow(Ext.AbstractComponent,["constructPlugin"])});