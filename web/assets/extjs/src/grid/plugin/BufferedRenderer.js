Ext.define("Ext.grid.plugin.BufferedRenderer",{extend:"Ext.AbstractPlugin",requires:["Ext.grid.plugin.BufferedRendererTableView","Ext.grid.plugin.BufferedRendererTreeView"],alias:"plugin.bufferedrenderer",lockableScope:"both",percentageFromEdge:0.35,variableRowHeight:false,numFromEdge:8,trailingBufferZone:10,leadingBufferZone:20,synchronousRender:true,scrollToLoadBuffer:200,viewSize:0,rowHeight:21,position:0,lastScrollDirection:1,bodyTop:0,init:function(c){var d=this,a=c.view,b={scroll:{fn:d.onViewScroll,element:"el",scope:d},boxready:d.onViewResize,resize:d.onViewResize,refresh:d.onViewRefresh,scope:d,destroyable:true};if(!d.variableRowHeight&&c.ownerLockable){c.ownerLockable.syncRowHeight=false}if(c.isTree||c.ownerLockable&&c.ownerLockable.isTree){a.blockRefresh=false;a.loadMask=true}if(a.positionBody){b.refresh=d.onViewRefresh}d.grid=c;d.view=a;a.bufferedRenderer=d;a.preserveScrollOnRefresh=true;d.bindStore(a.dataSource);a.getViewRange=function(){return d.getViewRange()};d.position=0;d.gridListeners=c.on("reconfigure",d.onReconfigure,d);d.viewListeners=a.on(b)},bindStore:function(a){var b=this;if(b.store){b.unbindStore()}b.storeListeners=a.on({scope:b,clear:b.onStoreClear,destroyable:true});b.store=a;if(b.view.componentLayout.layoutCount){b.onViewResize(b.view,0,b.view.getHeight())}},onReconfigure:function(b,a){if(a&&a!==this.store){this.bindStore(a)}},unbindStore:function(){this.storeListeners.destroy();this.store=null},onStoreClear:function(){var a=this;if(a.view.rendered&&!a.store.isDestroyed){if(a.scrollTop!==0){a.ignoreNextScrollEvent=true;a.view.el.dom.scrollTop=a.bodyTop=a.scrollTop=0}a.position=a.scrollHeight=0;a.lastScrollDirection=a.scrollOffset=null;delete a.rowHeight}},onViewRefresh:function(){var c=this,a=c.view,d=c.scrollHeight,b;if(a.all.getCount()){delete c.rowHeight}b=c.getScrollHeight();if(!d||b!=d){c.stretchView(a,b)}if(c.scrollTop!==a.el.dom.scrollTop){c.onViewScroll()}else{c.setBodyTop(c.bodyTop);if(a.all.getCount()){c.viewSize=0;c.onViewResize(a,null,a.getHeight())}}},onViewResize:function(c,e,a,b,g){if(!g||a!==g){var f=this,d;d=Math.ceil(a/f.rowHeight)+f.trailingBufferZone+f.leadingBufferZone;f.viewSize=f.setViewSize(d)}},stretchView:function(b,a){var e=this,d=(e.store.buffered?e.store.getTotalCount():e.store.getCount());if(e.stretcher){e.stretcher.dom.style.marginTop=(a-1)+"px"}else{var c=b.el;if(b.refreshCounter){b.fixedNodes++}if(d&&(e.view.all.endIndex===d-1)){a=e.bodyTop+b.body.dom.offsetHeight}this.stretcher=c.createChild({style:{width:"1px",height:"1px",marginTop:(a-1)+"px",left:0,position:"absolute"}},c.dom.firstChild)}},setViewSize:function(g){if(g!==this.viewSize){this.scrollTop=this.view.el.dom.scrollTop;var e=this,b=e.store,d=e.view.all.getCount(),f,a,c=e.lockingPartner;e.viewSize=b.viewSize=g;if(d){f=e.view.all.startIndex;a=Math.min(f+g-1,(b.buffered?b.getTotalCount():b.getCount())-1);if(c){c.disable()}e.renderRange(f,a);if(c){c.enable()}}}return g},getViewRange:function(){var b=this,c=b.view.all,a=b.store;if(a.data.getCount()){return a.getRange(c.startIndex,c.startIndex+(b.viewSize||b.store.defaultViewSize)-1)}else{return[]}},scrollTo:function(i,c,l,n){var f=this,h=f.view,m=h.el.dom,j=f.store,g=j.buffered?j.getTotalCount():j.getCount(),e,b,d,a,k;i=Math.min(Math.max(i,0),g-1);e=Math.max(Math.min(i-((f.leadingBufferZone+f.trailingBufferZone)/2),g-f.viewSize+1),0);k=e*f.rowHeight;b=Math.min(e+f.viewSize-1,g-1);j.getRange(e,b,{callback:function(p,q,o){f.renderRange(q,o,true);d=j.data.getRange(i,i)[0];a=h.getNode(d,false);h.body.dom.style.top=k+"px";f.position=f.scrollTop=m.scrollTop=k=Math.min(Math.max(0,k-h.body.getOffsetsTo(a)[1]),m.scrollHeight-m.clientHeight);if(Ext.isIE){m.scrollTop=k}if(c){h.selModel.select(d)}if(l){l.call(n||f,i,d)}}})},onViewScroll:function(d,j){var f=this,h=f.store,i=(h.buffered?h.getTotalCount():h.getCount()),c,a,b=f.scrollTop=f.view.el.dom.scrollTop,g=false;if(f.ignoreNextScrollEvent){f.ignoreNextScrollEvent=false;return}if(!(f.disabled||i<f.viewSize)){c=b-f.position;a=c>0?1:-1;if(Math.abs(c)>=20||(a!==f.lastScrollDirection)){f.lastScrollDirection=a;f.handleViewScroll(f.lastScrollDirection);g=true}}if(!g){if(f.lockingPartner&&f.lockingPartner.scrollTop!==b){f.lockingPartner.view.el.dom.scrollTop=b}}},handleViewScroll:function(g){var e=this,f=e.view.all,b=e.store,h=e.viewSize,a=(b.buffered?b.getTotalCount():b.getCount()),d,c;if(g==-1){if(f.startIndex){if((e.getFirstVisibleRowIndex()-f.startIndex)<e.numFromEdge){d=Math.max(0,e.getLastVisibleRowIndex()+e.trailingBufferZone-h)}}}else{if(f.endIndex<a-1){if((f.endIndex-e.getLastVisibleRowIndex())<e.numFromEdge){d=Math.max(0,e.getFirstVisibleRowIndex()-e.trailingBufferZone)}}}if(d!=null){c=Math.min(d+h-1,a-1);if(d!==f.startIndex||c!==f.endIndex){e.renderRange(d,c);return}}if(e.lockingPartner&&e.lockingPartner.view.el&&e.lockingPartner.scrollTop!==e.scrollTop){e.lockingPartner.view.el.dom.scrollTop=e.scrollTop}},renderRange:function(e,a,d){var c=this,b=c.store;if(b.rangeCached(e,a)){c.cancelLoad();if(c.synchronousRender||d){c.onRangeFetched(null,e,a)}else{if(!c.renderTask){c.renderTask=new Ext.util.DelayedTask(c.onRangeFetched,c,null,false)}c.renderTask.delay(1,null,null,[null,e,a])}}else{c.attemptLoad(e,a)}},onRangeFetched:function(g,b,e,c){var i=this,k=i.view,d,m=k.all,a,l=0,f=b*i.rowHeight,j,h=i.lockingPartner;if(k.isDestroyed){return}if(!g){g=i.store.getRange(b,e);if(!g){return}}if(b>m.endIndex||e<m.startIndex){m.clear(true);j=f}if(!m.getCount()){k.doAdd(g,b)}else{if(e>m.endIndex){a=Math.max(b-m.startIndex,0);if(i.variableRowHeight){l=m.item(m.startIndex+a,true).offsetTop}m.scroll(Ext.Array.slice(g,m.endIndex+1-b),1,a,b,e);if(i.variableRowHeight){j=i.bodyTop+l}else{j=f}}else{a=Math.max(m.endIndex-e,0);d=m.startIndex;m.scroll(Ext.Array.slice(g,0,m.startIndex-b),-1,a,b,e);if(i.variableRowHeight){j=i.bodyTop-m.item(d,true).offsetTop}else{j=f}}}i.position=i.scrollTop;if(k.positionBody){i.setBodyTop(j,f)}if(h&&!h.disabled&&!c){h.onRangeFetched(g,b,e,true);if(h.scrollTop!==i.scrollTop){h.view.el.dom.scrollTop=i.scrollTop}}},setBodyTop:function(d,f){var e=this,b=e.view,c=e.store,a=b.body.dom,g;d=Math.floor(d);if(f!==undefined){g=d-f;d=f}a.style.position="absolute";a.style.top=(e.bodyTop=d)+"px";if(g){e.scrollTop=e.position=b.el.dom.scrollTop-=g}if(b.all.endIndex===(c.buffered?c.getTotalCount():c.getCount())-1){e.stretchView(b,e.bodyTop+a.offsetHeight)}},getFirstVisibleRowIndex:function(i,c,b,f){var g=this,h=g.view,k=h.all,a=k.elements,d=h.el.dom.clientHeight,e,j;if(k.getCount()&&g.variableRowHeight){if(!arguments.length){i=k.startIndex;c=k.endIndex;b=g.scrollTop;f=b+d;if(g.bodyTop>f||g.bodyTop+h.body.getHeight()<b){return Math.floor(g.scrollTop/g.rowHeight)}e=i+Math.min(g.numFromEdge+((g.lastScrollDirection==-1)?g.leadingBufferZone:g.trailingBufferZone),Math.floor((c-i)/2))}else{e=i+Math.floor((c-i)/2)}j=g.bodyTop+a[e].offsetTop;if(j+a[e].offsetHeight<b){return g.getFirstVisibleRowIndex(e+1,c,b,f)}if(j<=b){return e}else{if(e!==i){return g.getFirstVisibleRowIndex(i,e-1,b,f)}}}return Math.floor(g.scrollTop/g.rowHeight)},getLastVisibleRowIndex:function(j,c,b,f){var h=this,i=h.view,l=i.all,a=l.elements,d=i.el.dom.clientHeight,e,k,g;if(l.getCount()&&h.variableRowHeight){if(!arguments.length){j=l.startIndex;c=l.endIndex;b=h.scrollTop;f=b+d;if(h.bodyTop>f||h.bodyTop+i.body.getHeight()<b){return Math.floor(h.scrollTop/h.rowHeight)+Math.ceil(d/h.rowHeight)}e=c-Math.min(h.numFromEdge+((h.lastScrollDirection==1)?h.leadingBufferZone:h.trailingBufferZone),Math.floor((c-j)/2))}else{e=j+Math.floor((c-j)/2)}k=h.bodyTop+a[e].offsetTop;if(k>f){return h.getLastVisibleRowIndex(j,e-1,b,f)}g=k+a[e].offsetHeight;if(g>=f){return e}else{if(e!==c){return h.getLastVisibleRowIndex(e+1,c,b,f)}}}return h.getFirstVisibleRowIndex()+Math.ceil(d/h.rowHeight)},getScrollHeight:function(){var d=this,a=d.view,b=d.store,c=!d.hasOwnProperty("rowHeight"),e=d.store.getCount();if(!e){return 0}if(c){if(a.all.getCount()){d.rowHeight=Math.floor(a.body.getHeight()/a.all.getCount())}}return this.scrollHeight=Math.floor((b.buffered?b.getTotalCount():b.getCount())*d.rowHeight)},attemptLoad:function(c,a){var b=this;if(b.scrollToLoadBuffer){if(!b.loadTask){b.loadTask=new Ext.util.DelayedTask(b.doAttemptLoad,b,[])}b.loadTask.delay(b.scrollToLoadBuffer,b.doAttemptLoad,b,[c,a])}else{b.store.getRange(c,a,{callback:b.onRangeFetched,scope:b,fireEvent:false})}},cancelLoad:function(){if(this.loadTask){this.loadTask.cancel()}},doAttemptLoad:function(b,a){this.store.getRange(b,a,{callback:this.onRangeFetched,scope:this,fireEvent:false})},destroy:function(){var b=this,a=b.view;if(a&&a.el){a.el.un("scroll",b.onViewScroll,b)}Ext.destroy(b.viewListeners,b.storeListeners,b.gridListeners)}});