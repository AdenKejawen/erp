Ext.define("Ext.grid.plugin.BufferedRenderer",{extend:"Ext.AbstractPlugin",alias:"plugin.bufferedrenderer",lockableScope:"both",percentageFromEdge:0.35,variableRowHeight:false,numFromEdge:8,trailingBufferZone:10,leadingBufferZone:20,scrollToLoadBuffer:200,viewSize:0,rowHeight:21,tableStart:0,tableEnd:0,position:0,lastScrollDirection:1,bodyTop:0,constructor:function(a){var b=this;Ext.apply(b,a);b.callParent(arguments)},init:function(c){var d=this,a=c.view,b={scroll:{fn:d.onViewScroll,element:"el",scope:d},refresh:d.onViewRefresh,resize:d.onViewResize,scope:d,destroyable:true};if(a.positionBody){b.refresh=d.onViewRefresh}d.grid=c;d.view=a;a.bufferedRenderer=d;d.bindStore(a.dataSource);a.getViewRange=function(){return d.getViewRange()};d.position=0;d.viewListeners=a.on(b)},bindStore:function(a){var b=this;if(b.store){b.unbindStore()}b.storeListeners=a.on({scope:b,clear:b.onStoreClear,destroyable:true});b.store=a;if(b.view.componentLayout.layoutCount){b.onViewResize(b.view,0,b.view.getHeight())}},unbindStore:function(){this.storeListeners.destroy();this.store=null},onStoreClear:function(){var a=this;if(a.view.rendered&&!a.store.isDestroyed){if(a.scrollTop!==0){a.ignoreNextScrollEvent=true;a.view.el.dom.scrollTop=a.bodyTop=a.scrollTop=0}a.position=0;delete a.lastScrollDirection;delete a.scrollOffset;delete a.rowHeight}},onViewRefresh:function(){var b=this,a=b.view;b.setBodyTop(b.bodyTop);if(a.all.getCount()){b.viewSize=0;b.onViewResize(a,null,a.getHeight())}},onViewResize:function(d,f,b,c,h){if(!h||b!==h){var g=this,e,a;if(d.all.getCount()){delete g.rowHeight}a=g.getScrollHeight();e=Math.ceil(b/g.rowHeight)+g.trailingBufferZone+g.leadingBufferZone;g.viewSize=g.setViewSize(e);g.stretchView(d,a)}},stretchView:function(b,a){var d=this;if(d.stretcher){d.stretcher.dom.style.marginTop=(a-1)+"px"}else{var c=b.el;if(b.refreshCounter){b.fixedNodes++}if(d.store.getTotalCount()&&(d.view.all.endIndex===d.store.getTotalCount()-1)){a=d.bodyTop+b.body.dom.offsetHeight}this.stretcher=c.createChild({style:{width:"1px",height:"1px",marginTop:(a-1)+"px",left:0,position:"absolute"}},c.dom.firstChild)}},setViewSize:function(f){if(f!==this.viewSize){this.scrollTop=this.view.el.dom.scrollTop;var d=this,b=d.store,c=d.view.all.getCount(),e,a;d.viewSize=b.viewSize=f;if(c){e=d.view.all.startIndex;a=Math.min(e+f-1,b.getTotalCount()-1);d.renderRange(e,a)}}return f},getViewRange:function(){var b=this,c=b.view.all,a=b.store;if(a.data.getCount()){return a.getRange(c.startIndex,c.startIndex+b.viewSize-1)}else{return[]}},scrollTo:function(j,c,l,n){var f=this,h=f.view,a=h.ownerCt,m=h.el.dom,i=f.store,g=i.getTotalCount(),e,b,d,k;j=Math.min(Math.max(j,0),g-1);e=Math.max(Math.min(j-((f.leadingBufferZone+f.trailingBufferZone)/2),g-f.viewSize+1),0);k=e*f.rowHeight;b=e+f.viewSize-1;f.disabled=true;i.getRange(e,b,{callback:function(p,q,o){h.all.clear(true);h.doAdd(p,q,o);d=i.data.getRange(j,j)[0];h.body.dom.style.top=k+"px";f.position=f.scrollTop=m.scrollTop=k=Math.min(Math.max(0,k-h.body.getOffsetsTo(h.getNode(d,false))[1]),m.scrollHeight-m.clientHeight);if(Ext.isIE){m.scrollTop=k}f.disabled=false;if(c){a.selModel.select(d)}if(l){l.call(n||f,j,d)}}})},onViewScroll:function(f,a){var c=this,b,g,d=c.view.el.dom.scrollTop;if(c.ignoreNextScrollEvent){c.ignoreNextScrollEvent=false;return}if(!c.disabled){b=d-c.position;g=b>0?1:-1;c.scrollTop=d;if(Math.abs(b)>=20||(g!==c.lastScrollDirection)){c.position=d;c.lastScrollDirection=g;c.handleViewScroll(c.lastScrollDirection)}}},handleViewScroll:function(g){var e=this,f=e.view.all,b=e.store,h=e.viewSize,a=b.getTotalCount(),d,c;if(a>=h){if(g==-1){if(f.startIndex){if((e.getFirstVisibleRowIndex()-f.startIndex)<e.numFromEdge){d=Math.max(0,e.getLastVisibleRowIndex()+e.trailingBufferZone-h)}}}else{if(f.endIndex<a-1){if((f.endIndex-e.getLastVisibleRowIndex())<e.numFromEdge){d=Math.max(0,e.getFirstVisibleRowIndex()-e.trailingBufferZone)}}}if(d!==undefined){c=Math.min(d+h-1,a-1);if(d!==f.startIndex||c!==f.endIndex){e.renderRange(d,c)}}}},renderRange:function(d,a){var c=this,b=c.store;if(b.rangeCached(d,a)){c.cancelLoad();if(c.synchronousRender){c.onRangeFetched(null,d,a)}else{if(!c.renderTask){c.renderTask=new Ext.util.DelayedTask(c.onRangeFetched,c,null,false)}c.renderTask.delay(1,null,null,[null,d,a])}}else{c.attemptLoad(d,a)}},onRangeFetched:function(f,a,d){var g=this,i=g.view,c,k=i.all,b,j=0,e=a*g.rowHeight,h;if(!f){f=g.store.getRange(a,d)}if(a>k.endIndex||d<k.startIndex){k.clear(true);h=e}if(!k.getCount()){i.doAdd(f,a)}else{if(d>k.endIndex){b=Math.max(a-k.startIndex,0);if(g.variableRowHeight){j=k.item(k.startIndex+b,true).offsetTop}k.scroll(Ext.Array.slice(f,k.endIndex+1-a),1,b,a,d);if(g.variableRowHeight){h=g.bodyTop+j}else{h=e}}else{b=Math.max(k.endIndex-d,0);c=k.startIndex;k.scroll(Ext.Array.slice(f,0,k.startIndex-a),-1,b,a,d);if(g.variableRowHeight){h=g.bodyTop-k.item(c,true).offsetTop}else{h=e}}}if(i.positionBody){g.setBodyTop(h,e)}},setBodyTop:function(c,e){var d=this,b=d.view,a=b.body.dom,f;c=Math.floor(c);if(e!==undefined){f=c-e;c=e}a.style.position="absolute";a.style.top=(d.bodyTop=c)+"px";if(f){d.scrollTop=d.position=b.el.dom.scrollTop-=f}if(d.view.all.endIndex===d.store.getTotalCount()-1){d.stretchView(b,d.bodyTop+a.offsetHeight)}},getFirstVisibleRowIndex:function(i,c,b,f){var g=this,h=g.view,k=h.all,a=k.elements,d=h.el.dom.clientHeight,e,j;if(k.getCount()&&g.variableRowHeight){if(!arguments.length){i=k.startIndex;c=k.endIndex;b=g.scrollTop;f=b+d;if(g.bodyTop>f||g.bodyTop+h.body.getHeight()<b){return Math.floor(g.scrollTop/g.rowHeight)}e=i+Math.min(g.numFromEdge+((g.lastScrollDirection==-1)?g.leadingBufferZone:g.trailingBufferZone),Math.floor((c-i)/2))}else{e=i+Math.floor((c-i)/2)}j=g.bodyTop+a[e].offsetTop;if(j+a[e].offsetHeight<b){return g.getFirstVisibleRowIndex(e+1,c,b,f)}if(j<=b){return e}else{if(e!==i){return g.getFirstVisibleRowIndex(i,e-1,b,f)}}}return Math.floor(g.scrollTop/g.rowHeight)},getLastVisibleRowIndex:function(j,c,b,f){var h=this,i=h.view,l=i.all,a=l.elements,d=i.el.dom.clientHeight,e,k,g;if(l.getCount()&&h.variableRowHeight){if(!arguments.length){j=l.startIndex;c=l.endIndex;b=h.scrollTop;f=b+d;if(h.bodyTop>f||h.bodyTop+i.body.getHeight()<b){return Math.floor(h.scrollTop/h.rowHeight)+Math.ceil(d/h.rowHeight)}e=c-Math.min(h.numFromEdge+((h.lastScrollDirection==1)?h.leadingBufferZone:h.trailingBufferZone),Math.floor((c-j)/2))}else{e=j+Math.floor((c-j)/2)}k=h.bodyTop+a[e].offsetTop;if(k>f){return h.getLastVisibleRowIndex(j,e-1,b,f)}g=k+a[e].offsetHeight;if(g>=f){return e}else{if(e!==c){return h.getLastVisibleRowIndex(e+1,c,b,f)}}}return h.getFirstVisibleRowIndex()+Math.ceil(d/h.rowHeight)},getScrollHeight:function(){var d=this,a=d.view,b=d.store,c=!d.hasOwnProperty("rowHeight"),e=d.store.getCount();if(!e){return 0}if(c){if(a.all.getCount()){d.rowHeight=Math.floor(a.body.getHeight()/a.all.getCount())}}return Math.floor(b.getTotalCount()*d.rowHeight)},attemptLoad:function(c,a){var b=this;if(b.scrollToLoadBuffer){if(!b.loadTask){b.loadTask=new Ext.util.DelayedTask(b.doAttemptLoad,b,[])}b.loadTask.delay(b.scrollToLoadBuffer,b.doAttemptLoad,b,[c,a])}else{b.store.getRange(c,a,{callback:b.onRangeFetched,scope:b,fireEvent:false})}},cancelLoad:function(){if(this.loadTask){this.loadTask.cancel()}},doAttemptLoad:function(b,a){this.store.getRange(b,a,{callback:this.onRangeFetched,scope:this,fireEvent:false})},destroy:function(){var b=this,a=b.view;if(a&&a.el){a.el.un("scroll",b.onViewScroll,b)}Ext.destroy(b.viewListeners,b.storeListeners)}});