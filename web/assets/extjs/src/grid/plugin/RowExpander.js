Ext.define("Ext.grid.plugin.RowExpander",{extend:"Ext.AbstractPlugin",lockableScope:"normal",requires:["Ext.grid.feature.RowBody","Ext.grid.feature.RowWrap"],alias:"plugin.rowexpander",rowBodyTpl:null,expandOnEnter:true,expandOnDblClick:true,selectRowOnExpand:false,rowBodyTrSelector:".x-grid-rowbody-tr",rowBodyHiddenCls:"x-grid-row-body-hidden",rowCollapsedCls:"x-grid-row-collapsed",addCollapsedCls:{before:function(a,b){var c=this.rowExpander;if(!c.recordsExpanded[a.record.internalId]){a.itemClasses.push(c.rowCollapsedCls)}},priority:500},setCmp:function(b){var d=this,a,c;d.callParent(arguments);d.recordsExpanded={};if(!d.rowBodyTpl){Ext.Error.raise("The 'rowBodyTpl' config is required and is not defined.")}d.rowBodyTpl=Ext.XTemplate.getTpl(d,"rowBodyTpl");a=this.rowBodyTpl;c=[{ftype:"rowbody",lockableScope:"normal",recordsExpanded:d.recordsExpanded,rowBodyHiddenCls:d.rowBodyHiddenCls,rowCollapsedCls:d.rowCollapsedCls,setupRowData:d.getRowBodyFeatureData,setup:d.setup,getRowBodyContents:function(e){return a.applyTemplate(e.getData())}},{ftype:"rowwrap",lockableScope:"normal"}];if(b.features){b.features=Ext.Array.push(c,b.features)}else{b.features=c}},init:function(c){var e=this,b=c,a,d;e.callParent(arguments);e.grid=c;a=e.view=c.getView();e.addExpander();e.bindView(a);a.addRowTpl(e.addCollapsedCls).rowExpander=e;if(c.ownerLockable){b=c.ownerLockable;b.syncRowHeight=false;d=b.lockedGrid.getView();e.bindView(d);d.addRowTpl(e.addCollapsedCls).rowExpander=e;b.mon(b,"columnschanged",e.refreshRowHeights,e);b.mon(b.store,"datachanged",e.refreshRowHeights,e)}b.on("beforereconfigure",e.beforeReconfigure,e);if(c.ownerLockable&&!c.rowLines){a.on("rowfocus",e.refreshRowHeights,e)}},beforeReconfigure:function(d,a,c,e,b){var f=this.getHeaderConfig();f.locked=true;c.unshift(f)},addExpander:function(){var b=this,a=b.grid,c=b.getHeaderConfig();if(a.ownerLockable){a=a.ownerLockable.lockedGrid;a.width+=c.width}a.headerCt.insert(0,c)},getRowBodyFeatureData:function(b,a,d){var c=this;c.self.prototype.setupRowData.apply(c,arguments);d.rowBody=c.getRowBodyContents(b);d.rowBodyCls=c.recordsExpanded[b.internalId]?"":c.rowBodyHiddenCls},setup:function(b,c){var a=this;a.self.prototype.setup.apply(a,arguments);if(!a.grid.ownerLockable){c.rowBodyColspan-=1}},bindView:function(a){if(this.expandOnEnter){a.on("itemkeydown",this.onKeyDown,this)}if(this.expandOnDblClick){a.on("itemdblclick",this.onDblClick,this)}},onKeyDown:function(j,f,k,a,g){if(g.getKey()==g.ENTER){var b=j.store,c=j.getSelectionModel().getSelection(),h=c.length,d=0;for(;d<h;d++){a=b.indexOf(c[d]);this.toggleRow(a,c[d])}}},onDblClick:function(b,a,f,c,d){this.toggleRow(c,a)},toggleRow:function(b,e){var g=this,i=g.view,c=i.getNode(b),l=Ext.fly(c,"_rowExpander"),f=l.down(g.rowBodyTrSelector,true),d=l.hasCls(g.rowCollapsedCls),j=d?"removeCls":"addCls",h,a,k;Ext.suspendLayouts();l[j](g.rowCollapsedCls);Ext.fly(f)[j](g.rowBodyHiddenCls);g.recordsExpanded[e.internalId]=d;i.refreshSize();if(g.grid.ownerLockable){h=g.grid.ownerLockable;k=h.getView();i=h.lockedGrid.view;a=l.getHeight();l=Ext.fly(i.getNode(b),"_rowExpander");l.setHeight(a);l[j](g.rowCollapsedCls);i.refreshSize()}else{k=i}k.fireEvent(d?"expandbody":"collapsebody",l.dom,e,f);Ext.resumeLayouts(true)},refreshRowHeights:function(){Ext.globalEvents.on({idle:this.doRefreshRowHeights,scope:this,single:true})},doRefreshRowHeights:function(){var g=this,i=g.recordsExpanded,h,e,j=g.grid.ownerLockable.lockedGrid.view,a=g.grid.ownerLockable.normalGrid.view,c,d,f,b;for(h in i){if(i.hasOwnProperty(h)){e=this.view.store.data.get(h);d=j.getNode(e,false);c=a.getNode(e,false);d.style.height=c.style.height="";f=d.offsetHeight;b=c.offsetHeight;if(b>f){d.style.height=b+"px"}else{if(f>b){c.style.height=f+"px"}}}}},getHeaderConfig:function(){var a=this;return{width:24,lockable:false,sortable:false,resizable:false,draggable:false,hideable:false,menuDisabled:true,tdCls:Ext.baseCSSPrefix+"grid-cell-special",innerCls:Ext.baseCSSPrefix+"grid-cell-inner-row-expander",renderer:function(c,b){if(!a.grid.ownerLockable){b.tdAttr+=' rowspan="2"'}return'<div class="'+Ext.baseCSSPrefix+'grid-row-expander"></div>'},processEvent:function(g,d,b,i,f,h,c){if(g=="mousedown"&&h.getTarget(".x-grid-row-expander")){a.toggleRow(i,c);return a.selectRowOnExpand}}}}});