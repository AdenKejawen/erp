Ext.define("Ext.grid.plugin.CellEditing",{alias:"plugin.cellediting",extend:"Ext.grid.plugin.Editing",requires:["Ext.grid.CellEditor","Ext.util.DelayedTask"],lockableScope:"both",constructor:function(){this.callParent(arguments);this.editors=new Ext.util.MixedCollection(false,function(a){return a.editorId});this.editTask=new Ext.util.DelayedTask()},onReconfigure:function(c,a,b){if(b){this.editors.clear()}this.callParent()},destroy:function(){var a=this;a.editTask.cancel();a.editors.each(Ext.destroy,Ext);a.editors.clear();a.callParent(arguments)},onBodyScroll:function(){var c=this,b=c.getActiveEditor(),a=c.view.el.getScroll();if(b&&b.editing&&b.editingPlugin===c){if(a.top!==c.scroll.top){if(b.field){if(b.field.triggerBlur){b.field.triggerBlur()}else{b.field.blur()}}}else{b.realign()}}c.scroll=a},initCancelTriggers:function(){var c=this,b=c.grid,a=b.view;c.mon(a,"bodyscroll",c.onBodyScroll,c);c.mon(b,{columnresize:c.cancelEdit,columnmove:c.cancelEdit,scope:c})},isCellEditable:function(a,d){var c=this,b=c.getEditingContext(a,d);if(c.grid.view.isVisible(true)&&b){d=b.column;a=b.record;if(d&&c.getEditor(a,d)){return true}}},startEdit:function(a,e,c){var d=this,b;c=c||d.getEditingContext(a,e);d.completeEdit();if(!c||!d.grid.view.isVisible(true)){return false}a=c.record;e=c.column;if(e&&!e.getEditor(a)){return false}c.originalValue=c.value=a.get(e.dataIndex);if(d.beforeEdit(c)===false||d.fireEvent("beforeedit",d,c)===false||c.cancel){return false}b=d.getEditor(a,e);d.grid.view.cancelFocus();d.view.focusCell({row:c.rowIdx,column:c.colIdx});if(b){d.editTask.delay(15,d.showEditor,d,[b,c,c.value]);return true}return false},showEditor:function(e,a,g){var f=this,d=a.record,c=a.column,b=f.grid.getSelectionModel(),h=b.getCurrentPosition(),i=h&&h.view;if(i&&i!==f.view){return f.lockingPartner.showEditor(e,f.lockingPartner.getEditingContext(h.record,h.columnHeader),g)}f.setEditingContext(a);f.setActiveEditor(e);f.setActiveRecord(d);f.setActiveColumn(c);if(b.selectByPosition&&(!h||h.column!==a.colIdx||h.row!==a.rowIdx)){b.selectByPosition({row:a.rowIdx,column:a.colIdx,view:f.view})}e.startEdit(f.getCell(d,c),g,a);f.editing=true;f.scroll=f.view.el.getScroll()},completeEdit:function(){var a=this.getActiveEditor();if(a){a.completeEdit();this.editing=false}},setEditingContext:function(a){this.context=a;if(this.lockingPartner){this.lockingPartner.context=a}},setActiveEditor:function(a){this.activeEditor=a;if(this.lockingPartner){this.lockingPartner.activeEditor=a}},getActiveEditor:function(){return this.activeEditor},setActiveColumn:function(a){this.activeColumn=a;if(this.lockingPartner){this.lockingPartner.activeColumn=a}},getActiveColumn:function(){return this.activeColumn},setActiveRecord:function(a){this.activeRecord=a;if(this.lockingPartner){this.lockingPartner.activeRecord=a}},getActiveRecord:function(){return this.activeRecord},getEditor:function(a,e){var g=this,f=g.editors,d=e.getItemId(),c=f.getByKey(d),b=g.grid.ownerLockable||g.grid;if(!c&&g.lockingPartner){c=g.lockingPartner.editors.getByKey(d)}if(!c){c=e.getEditor(a);if(!c){return false}if(c instanceof Ext.grid.CellEditor){c.editingPlugin=g;c.floating=true;c.isForTree=g.grid.isTree}else{c=new Ext.grid.CellEditor({editingPlugin:g,floating:true,editorId:d,field:c,isForTree:g.grid.isTree})}b.add(c);c.on({scope:g,specialkey:g.onSpecialKey,complete:g.onEditComplete,canceledit:g.cancelEdit});e.on("removed",g.cancelActiveEdit,g);f.add(c)}return c},cancelActiveEdit:function(b){var a=this.context;if(a&&a.column===b){this.cancelEdit()}},setColumnField:function(b,c){var a=this.editors.getByKey(b.getItemId());Ext.destroy(a,b.field);this.editors.removeAtKey(b.getItemId());this.callParent(arguments)},getCell:function(a,b){return this.grid.getView().getCell(a,b)},onSpecialKey:function(a,c,b){var d;if(b.getKey()===b.TAB){b.stopEvent();if(a){a.onEditorTab(b)}d=a.up("tablepanel").getSelectionModel();if(d.onEditorTab){return d.onEditorTab(a.editingPlugin,b)}}},onEditComplete:function(g,i,d){var h=this,a=h.grid,b=h.getActiveColumn(),e=a.getSelectionModel(),c=h.context,f;if(b){f=c.record;h.setActiveEditor(null);h.setActiveColumn(null);h.setActiveRecord(null);c.value=i;if(!h.validateEdit()){return}if(!f.isEqual(i,d)){f.set(b.dataIndex,i)}if(e.setCurrentPosition){e.setCurrentPosition(e.getCurrentPosition())}a.getView().getEl(b).focus();h.fireEvent("edit",h,c);h.editing=false}},cancelEdit:function(){var c=this,b=c.getActiveEditor(),a=c.grid.getView().getEl(c.getActiveColumn());c.setActiveEditor(null);c.setActiveColumn(null);c.setActiveRecord(null);if(b){b.cancelEdit();a.focus();c.callParent(arguments);return}return true},startEditByPosition:function(a){a.column=this.view.getHeaderCt().getVisibleHeaderClosestToIndex(a.column).getIndex();return this.startEdit(a.row,a.column)}});