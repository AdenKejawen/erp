Ext.define("Ext.grid.feature.GroupStore",{extend:"Ext.util.Observable",isStore:true,constructor:function(c,a){var b=this;b.superclass.constructor.apply(b,arguments);b.groupingFeature=c;b.bindStore(a);b.processStore(a);b.view.dataSource=b},bindStore:function(a){var b=this;if(b.store){Ext.destroy(b.storeListeners);b.store=null}if(a){b.storeListeners=a.on({remove:b.onRemove,bulkremove:b.onBulkRemove,add:b.onAdd,update:b.onUpdate,refresh:b.onRefresh,clear:b.onClear,scope:b,destroyable:true});b.store=a}},processStore:function(h){var g=this,b=h.model,a=h.getGroups(),k=a.length,e,l,m,d=g.data,j=this.groupingFeature.groupCache,c=this.groupingFeature.groupCache={},f=g.groupingFeature.startCollapsed;if(d){d.clear()}else{d=g.data=new Ext.util.MixedCollection(false,Ext.data.Store.recordIdFn)}for(e=0;e<k;e++){l=a[e];c[l.name]=l;l.isCollapsed=f||(j[l.name]&&j[l.name].isCollapsed);if(l.isCollapsed){l.placeholder=m=new b(null,"group-"+l.name+"-placeholder");m.set(g.getGroupField(),l.name);m.rows=m.children=l.children;d.add(m)}else{d.insert(g.data.length,l.children)}}},isCollapsed:function(a){return this.groupingFeature.groupCache[a].isCollapsed},isInCollapsedGroup:function(a){var b;if(this.store.isGrouped()&&(b=this.groupingFeature.groupCache[a.get(this.getGroupField())])){return b.isCollapsed||false}return false},getCount:function(){return this.data.getCount()},getTotalCount:function(){return this.data.getCount()},rangeCached:function(){return true},getRange:function(b,a){return this.data.getRange(b,a)},getAt:function(a){return this.getRange(a,a)[0]},getById:function(a){return this.store.getById(a)},indexOf:function(d,h){var e=this,a,b,g,c,j,f,k=0;if(d&&!e.isInCollapsedGroup(d)){a=e.store.groupField;b=e.store.getGroups();g=b.length;for(c=0;c<g;c++){j=b[c];if(j.name===d.get(a)){f=Ext.Array.indexOf(j.children,d);return k+f}k+=(h&&this.isCollapsed(j.name))?1:j.children.length}}return -1},onRefresh:function(a){this.processStore(this.store);this.fireEvent("refresh",this)},onRemove:function(b,a,c){this.processStore(this.store);this.fireEvent("refresh",this)},onBulkRemove:function(b,a,c){this.processStore(this.store);this.fireEvent("refresh",this)},onClear:function(b,a,c){this.processStore(this.store);this.fireEvent("clear",this)},onAdd:function(b,a,c){this.processStore(this.store);this.fireEvent("refresh",this)},onUpdate:function(c,a,b,g){var f=this,d=f.groupingFeature.getRecordGroup(a),h,e;if(g&&Ext.Array.contains(g,f.groupingFeature.getGroupField())){return f.onRefresh(f.store)}if(d.isCollapsed){f.fireEvent("update",f,d.placeholder)}else{Ext.suspendLayouts();f.fireEvent("update",f,a,b,g);h=d.children[0];e=d.children[d.children.length-1];if(h!==a){f.fireEvent("update",f,h,"edit")}if(e!==a&&e!==h){f.fireEvent("update",f,e,"edit")}Ext.resumeLayouts(true)}}});