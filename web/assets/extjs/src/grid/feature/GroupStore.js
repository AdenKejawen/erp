Ext.define("Ext.grid.feature.GroupStore",{extend:"Ext.util.Observable",isStore:true,constructor:function(c,a){var b=this;b.superclass.constructor.apply(b,arguments);b.groupingFeature=c;b.bindStore(a);b.processStore(a);b.view.dataSource=b},bindStore:function(a){var b=this;if(b.store){Ext.destroy(b.storeListeners);b.store=null}if(a){b.storeListeners=a.on({bulkremove:b.onBulkRemove,add:b.onAdd,update:b.onUpdate,refresh:b.onRefresh,clear:b.onClear,scope:b,destroyable:true});b.store=a}},processStore:function(g){var f=this,a=g.getGroups(),j=a.length,d,k,l,c=f.data,h=f.groupingFeature.groupCache,b=f.groupingFeature.clearGroupCache(),e=f.groupingFeature.startCollapsed;if(c){c.clear()}else{c=f.data=new Ext.util.MixedCollection(false,Ext.data.Store.recordIdFn)}if(g.getCount()){f.groupingFeature.startCollapsed=false;for(d=0;d<j;d++){k=a[d];b[k.name]=k;k.isCollapsed=e||(h[k.name]&&h[k.name].isCollapsed);if(k.isCollapsed){k.placeholder=l=new g.model(null,"group-"+k.name+"-placeholder");l.set(f.getGroupField(),k.name);l.rows=l.children=k.children;l.isCollapsedPlaceholder=true;c.add(l)}else{c.insert(f.data.length,k.children)}}}},isCollapsed:function(a){return this.groupingFeature.groupCache[a].isCollapsed},isInCollapsedGroup:function(a){var b;if(this.store.isGrouped()&&(b=this.groupingFeature.groupCache[a.get(this.getGroupField())])){return b.isCollapsed||false}return false},getCount:function(){return this.data.getCount()},getTotalCount:function(){return this.data.getCount()},rangeCached:function(b,a){return a<this.getCount()},getRange:function(d,b,c){var a=this.data.getRange(d,b);if(c&&c.callback){c.callback.call(c.scope||this,a,d,b,c)}return a},getAt:function(a){return this.getRange(a,a)[0]},getById:function(a){return this.store.getById(a)},expandGroup:function(c){var b=this,a;if(typeof c==="string"){c=b.groupingFeature.groupCache[c]}if(c&&c.children.length&&(a=b.indexOf(c.children[0],true,true))!==-1){c.isCollapsed=false;b.isExpandingOrCollapsing=1;b.data.removeAt(a);b.fireEvent("bulkremove",b,[b.getGroupPlaceholder(c)],[a]);b.data.insert(a,c.children);b.fireEvent("add",b,c.children,a);b.fireEvent("groupexpand",b,c);b.isExpandingOrCollapsing=0}},collapseGroup:function(g){var e=this,d,h,c,b,a,f;if(typeof g==="string"){g=e.groupingFeature.groupCache[g]}if(g&&(a=g.children.length)&&(d=e.indexOf(g.children[0],true))!==-1){g.isCollapsed=true;e.isExpandingOrCollapsing=2;e.data.removeRange(d,a);f=new Array(a);for(c=0,b=d;c<a;c++,b++){f[c]=b}e.fireEvent("bulkremove",e,g.children,f);e.data.insert(d,h=e.getGroupPlaceholder(g));e.fireEvent("add",e,[h],d);e.fireEvent("groupcollapse",e,g);e.isExpandingOrCollapsing=0}},getGroupPlaceholder:function(a){if(!a.placeholder){var b=a.placeholder=new this.store.model(null,"group-"+a.name+"-placeholder");b.set(this.getGroupField(),a.name);b.rows=b.children=a.children;b.isCollapsedPlaceholder=true}return a.placeholder},indexOf:function(d,h,b){var e=this,a,g,c,j,f,k=0;if(d&&(b||!e.isInCollapsedGroup(d))){a=e.store.getGroups();g=a.length;for(c=0;c<g;c++){j=a[c];if(j.name===this.store.getGroupString(d)){f=Ext.Array.indexOf(j.children,d);return k+f}k+=(h&&e.isCollapsed(j.name))?1:j.children.length}}return -1},indexOfTotal:function(a){var b=a.index;if(b||b===0){return b}return this.istore.ndexOf(a)},onRefresh:function(a){this.processStore(this.store);this.fireEvent("refresh",this)},onBulkRemove:function(b,a,c){this.processStore(this.store);this.fireEvent("refresh",this)},onClear:function(b,a,c){this.processStore(this.store);this.fireEvent("clear",this)},onAdd:function(b,a,c){this.processStore(this.store);this.fireEvent("refresh",this)},onUpdate:function(c,a,b,g){var f=this,d=f.groupingFeature.getRecordGroup(a),h,e;if(c.isGrouped()){if(g&&Ext.Array.contains(g,f.groupingFeature.getGroupField())){return f.onRefresh(f.store)}if(d.isCollapsed){f.fireEvent("update",f,d.placeholder)}else{Ext.suspendLayouts();f.fireEvent("update",f,a,b,g);h=d.children[0];e=d.children[d.children.length-1];if(h!==a){f.fireEvent("update",f,h,"edit")}if(e!==a&&e!==h){f.fireEvent("update",f,e,"edit")}Ext.resumeLayouts(true)}}else{f.fireEvent("update",f,a,b,g)}}});