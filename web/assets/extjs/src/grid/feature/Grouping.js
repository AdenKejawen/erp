Ext.define("Ext.grid.feature.Grouping",{extend:"Ext.grid.feature.Feature",mixins:{summary:"Ext.grid.feature.AbstractSummary"},requires:["Ext.grid.feature.GroupStore"],alias:"feature.grouping",eventPrefix:"group",groupCls:Ext.baseCSSPrefix+"grid-group-hd",eventSelector:"."+Ext.baseCSSPrefix+"grid-group-hd",refreshData:{},groupInfo:{},wrapsItem:true,groupHeaderTpl:"{columnName}: {name}",depthToIndent:17,collapsedCls:Ext.baseCSSPrefix+"grid-group-collapsed",hdCollapsedCls:Ext.baseCSSPrefix+"grid-group-hd-collapsed",hdNotCollapsibleCls:Ext.baseCSSPrefix+"grid-group-hd-not-collapsible",collapsibleCls:Ext.baseCSSPrefix+"grid-group-hd-collapsible",ctCls:Ext.baseCSSPrefix+"group-hd-container",groupByText:"Group by this field",showGroupsText:"Show in groups",hideGroupedHeader:false,startCollapsed:false,enableGroupingMenu:true,enableNoGroups:true,collapsible:true,expandTip:"Click to expand. CTRL key collapses all others",collapseTip:"Click to collapse. CTRL/click collapses all others",showSummaryRow:false,tableTpl:{before:function(a){if(this.groupingFeature.disabled||a.rows.length===1&&a.rows[0].isSummary){return}this.groupingFeature.setup(a.rows,a.view.rowValues)},after:function(a){if(this.groupingFeature.disabled||a.rows.length===1&&a.rows[0].isSummary){return}this.groupingFeature.cleanup(a.rows,a.view.rowValues)},priority:200},groupTpl:["{%","var me = this.groupingFeature;","if (me.disabled) {","values.needsWrap = false;","} else {","me.setupRowData(values.record, values.recordIndex, values);","values.needsWrap = !me.disabled && (values.isFirstRow || values.summaryRecord);","}","%}",'<tpl if="needsWrap">','<tr data-boundView="{view.id}" data-recordId="{record.internalId}" data-recordIndex="{[values.isCollapsedGroup ? -1 : values.recordIndex]}"','class="{[values.itemClasses.join(" ")]} '+Ext.baseCSSPrefix+'grid-wrap-row<tpl if="!summaryRecord"> '+Ext.baseCSSPrefix+'grid-group-row</tpl>">','<td class="'+Ext.baseCSSPrefix+'group-hd-container" colspan="{columns.length}">','<tpl if="isFirstRow">',"{%",'var groupTitleStyle = (!values.view.lockingPartner || (values.view.ownerCt === values.view.ownerCt.ownerLockable.lockedGrid) || (values.view.lockingPartner.headerCt.getVisibleGridColumns().length === 0)) ? "" : "visibility:hidden";',"%}",'<div id="{groupId}" class="'+Ext.baseCSSPrefix+'grid-group-hd {collapsibleCls}" tabIndex="0">','<div class="'+Ext.baseCSSPrefix+'grid-group-title" style="{[groupTitleStyle]}">','{[values.groupHeaderTpl.apply(values.groupInfo, parent) || "&#160;"]}',"</div>","</div>","</tpl>",'<tpl if="summaryRecord || !isCollapsedGroup">','<table class="',Ext.baseCSSPrefix,"{view.id}-table ",Ext.baseCSSPrefix,"grid-table",'<tpl if="summaryRecord"> ',Ext.baseCSSPrefix,'grid-table-summary</tpl>"','border="0" cellspacing="0" cellpadding="0" style="width:100%">',"{[values.view.renderColumnSizer(out)]}",'<tpl if="!isCollapsedGroup">',"{%","values.itemClasses.length = 0;","this.nextTpl.applyOut(values, out, parent);","%}","</tpl>",'<tpl if="summaryRecord">',"{%me.outputSummaryRecord(values.summaryRecord, values, out);%}","</tpl>","</table>","</tpl>","</td>","</tr>","<tpl else>","{%this.nextTpl.applyOut(values, out, parent);%}","</tpl>",{priority:200,syncRowHeights:function(d,i){d=Ext.fly(d,"syncDest");i=Ext.fly(i,"sycSrc");var b=this.owner,e=d.down(b.eventSelector,true),f,g=d.down(b.summaryRowSelector,true),c,a,h;if(e&&(f=i.down(b.eventSelector,true))){e.style.height=f.style.height="";if((a=e.offsetHeight)>(h=f.offsetHeight)){Ext.fly(f).setHeight(a)}else{if(h>a){Ext.fly(e).setHeight(h)}}}if(g&&(c=i.down(b.summaryRowSelector,true))){g.style.height=c.style.height="";if((a=g.offsetHeight)>(h=c.offsetHeight)){Ext.fly(c).setHeight(a)}else{if(h>a){Ext.fly(g).setHeight(h)}}}},syncContent:function(b,g){b=Ext.fly(b,"syncDest");g=Ext.fly(g,"sycSrc");var a=this.owner,d=b.down(a.eventSelector,true),c=g.down(a.eventSelector,true),f=b.down(a.summaryRowSelector,true),e=g.down(a.summaryRowSelector,true);if(d&&c){Ext.fly(d).syncContent(c)}if(f&&e){Ext.fly(f).syncContent(e)}}}],constructor:function(){this.groupCache={};this.callParent(arguments)},init:function(b){var c=this,a=c.view;a.isGrouping=true;if(c.lockingPartner&&c.lockingPartner.groupCache){c.groupCache=c.lockingPartner.groupCache}c.mixins.summary.init.call(c);c.callParent(arguments);a.headerCt.on({columnhide:c.onColumnHideShow,columnshow:c.onColumnHideShow,columnmove:c.onColumnMove,scope:c});a.addTableTpl(c.tableTpl).groupingFeature=c;a.addRowTpl(Ext.XTemplate.getTpl(c,"groupTpl")).groupingFeature=c;a.preserveScrollOnRefresh=true;if(a.store.buffered){c.collapsible=false}else{if(this.lockingPartner&&this.lockingPartner.dataSource){c.dataSource=a.dataSource=this.lockingPartner.dataSource}else{c.dataSource=a.dataSource=new Ext.grid.feature.GroupStore(c,a.store)}}c.grid.on({reconfigure:c.onReconfigure});a.on({afterrender:c.afterViewRender,scope:c,single:true})},clearGroupCache:function(){var b=this,a=b.groupCache={};if(b.lockingPartner){b.lockingPartner.groupCache=a}return a},vetoEvent:function(a,c,d,b){if(b.type!=="mouseover"&&b.type!=="mouseout"&&b.type!=="mouseenter"&&b.type!=="mouseleave"&&b.getTarget(this.eventSelector)){return false}},enable:function(){var c=this,a=c.view,b=a.store,d;c.lastGroupField=c.getGroupField();a.isGrouping=true;if(c.lastGroupIndex){c.block();b.group(c.lastGroupIndex);c.unblock()}c.callParent();d=c.view.headerCt.getMenu().down("#groupToggleMenuItem");if(d){d.setChecked(true,true)}c.refreshIf()},disable:function(){var d=this,a=d.view,b=a.store,e,c;a.isGrouping=false;c=b.groupers.first();if(c){d.lastGroupIndex=c.property;d.block();b.clearGrouping();d.unblock()}d.callParent();e=d.view.headerCt.getMenu().down("#groupToggleMenuItem");if(e){e.setChecked(false,true)}d.refreshIf()},refreshIf:function(){var b=this.grid.ownerCt,a=this.view;if(!a.store.remoteGroup&&!this.blockRefresh){if(b&&b.lockable){b.view.refresh()}else{a.refresh()}}},afterViewRender:function(){var b=this,a=b.view;a.on({scope:b,groupclick:b.onGroupClick});if(b.enableGroupingMenu){b.injectGroupingMenu()}b.pruneGroupedHeader();b.lastGroupField=b.getGroupField();b.block();b.onGroupChange();b.unblock()},injectGroupingMenu:function(){var a=this,b=a.view.headerCt;b.showMenuBy=a.showMenuBy;b.getMenuItems=a.getMenuItems()},onColumnHideShow:function(c,f){var j=this.view,b=j.headerCt,a=b.getMenu(),e=a.down("#groupMenuItem"),k=b.getGridColumns().length,h,g,d;if(e){if(b.getVisibleGridColumns().length>1){e.enable()}else{e.disable()}}if(j.rendered){h=j.el.query("."+this.ctCls);for(d=0,g=h.length;d<g;++d){h[d].colSpan=k}}},onColumnMove:function(){var g=this,c=g.view.store,b,e,a,d,h,f;if(c.isGrouped()){b=c.getGroups();a=b.length;for(e=0;e<a;e++){d=b[e];h=d.children[0];f=d.children[d.children.length-1];c.fireEvent("update",c,h,"edit",null);if(f!==h){c.fireEvent("update",c,f,"edit",null)}}}},showMenuBy:function(b,g){var f=this.getMenu(),c=f.down("#groupMenuItem"),a=g.groupable===false||this.view.headerCt.getVisibleGridColumns().length<2?"disable":"enable",e=f.down("#groupToggleMenuItem"),d=this.view.store.isGrouped();c[a]();if(e){e.setChecked(d,true);e[d?"enable":"disable"]()}Ext.grid.header.Container.prototype.showMenuBy.apply(this,arguments)},getMenuItems:function(){var f=this,c=f.groupByText,e=f.disabled||!f.getGroupField(),a=f.showGroupsText,d=f.enableNoGroups,b=f.view.headerCt.getMenuItems;return function(){var g=b.call(this);g.push("-",{iconCls:Ext.baseCSSPrefix+"group-by-icon",itemId:"groupMenuItem",text:c,handler:f.onGroupMenuItemClick,scope:f});if(d){g.push({itemId:"groupToggleMenuItem",text:a,checked:!e,checkHandler:f.onGroupToggleMenuItemClick,scope:f})}return g}},onGroupMenuItemClick:function(c,f){var d=this,g=c.parentMenu,h=g.activeHeader,a=d.view,b=a.store;d.lastGroupIndex=null;d.block();d.enable();b.group(h.dataIndex);d.pruneGroupedHeader();d.unblock();d.refreshIf()},block:function(a){this.blockRefresh=this.view.blockRefresh=true;if(this.lockingPartner&&!a){this.lockingPartner.block(true)}},unblock:function(a){this.blockRefresh=this.view.blockRefresh=false;if(this.lockingPartner&&!a){this.lockingPartner.unblock(true)}},onGroupToggleMenuItemClick:function(a,b){this[b?"enable":"disable"]()},pruneGroupedHeader:function(){var a=this,b=a.getGroupedHeader();if(a.hideGroupedHeader&&b){Ext.suspendLayouts();if(a.prunedHeader&&a.prunedHeader!==b){a.prunedHeader.show()}a.prunedHeader=b;b.hide();Ext.resumeLayouts(true)}},getHeaderNode:function(a){return Ext.get(this.createGroupId(a))},getGroup:function(b){var a=this.groupCache,c=a[b];if(!c){c=a[b]={isCollapsed:false}}return c},isExpanded:function(a){return !this.getGroup(a).isCollapsed},expand:function(b,a){this.doCollapseExpand(false,b,a)},expandAll:function(){var e=this,a=e.view,d=e.groupCache,f,c=e.lockingPartner,b;for(f in d){if(d.hasOwnProperty(f)){d[f].isCollapsed=false}}Ext.suspendLayouts();a.suspendEvent("beforerefresh","refresh");if(c){b=c.view;b.suspendEvent("beforerefresh","refresh")}e.dataSource.onRefresh();a.resumeEvent("beforerefresh","refresh");if(c){b.resumeEvent("beforerefresh","refresh")}Ext.resumeLayouts(true);for(f in d){if(d.hasOwnProperty(f)){e.afterCollapseExpand(false,f);if(c){c.afterCollapseExpand(false,f)}}}},collapse:function(b,a){this.doCollapseExpand(true,b,a)},isAllCollapsed:function(){var b=this,a=b.groupCache,c;for(c in a){if(a.hasOwnProperty(c)){if(!a[c].isCollapsed){return false}}}return true},isAllExpanded:function(){var b=this,a=b.groupCache,c;for(c in a){if(a.hasOwnProperty(c)){if(a[c].isCollapsed){return false}}}return true},collapseAll:function(){var e=this,a=e.view,d=e.groupCache,f,c=e.lockingPartner,b;for(f in d){if(d.hasOwnProperty(f)){d[f].isCollapsed=true}}Ext.suspendLayouts();a.suspendEvent("beforerefresh","refresh");if(c){b=c.view;b.suspendEvent("beforerefresh","refresh")}e.dataSource.onRefresh();a.resumeEvent("beforerefresh","refresh");if(c){b.resumeEvent("beforerefresh","refresh")}if(c&&!c.isAllCollapsed()){c.collapseAll()}Ext.resumeLayouts(true);for(f in d){if(d.hasOwnProperty(f)){e.afterCollapseExpand(true,f);if(c){c.afterCollapseExpand(true,f)}}}},doCollapseExpand:function(e,f,a){var c=this,b=c.lockingPartner,d=c.groupCache[f];if(d.isCollapsed!=e){Ext.suspendLayouts();if(e){c.dataSource.collapseGroup(d)}else{c.dataSource.expandGroup(d)}Ext.resumeLayouts(true);c.afterCollapseExpand(e,f,a);if(b){b.afterCollapseExpand(e,f,false)}}},afterCollapseExpand:function(d,f,b){var c=this,a=c.view,e;e=Ext.get(this.getHeaderNode(f));a.fireEvent(d?"groupcollapse":"groupexpand",a,e,f);if(b){e.up(a.getItemSelector()).scrollIntoView(a.el,null,true)}},onGroupChange:function(){var d=this,e=d.getGroupField(),c,a,b;if(d.hideGroupedHeader){if(d.lastGroupField){c=d.getMenuItem(d.lastGroupField);if(c){c.setChecked(true)}}if(e){a=d.view.headerCt.getVisibleGridColumns();b=((a.length===1)&&(a[0].dataIndex==e));c=d.getMenuItem(e);if(c&&!b){c.setChecked(false)}}}d.refreshIf();d.lastGroupField=e},getMenuItem:function(b){var a=this.view,d=a.headerCt.down("gridcolumn[dataIndex="+b+"]"),c=a.headerCt.getMenu();return d?c.down("menuitem[headerId="+d.id+"]"):null},onGroupKey:function(c,b){var a=this,d=a.getGroupName(b.target);if(d){a.onGroupClick(a.view,b.target,d,b)}},onGroupClick:function(a,h,j,i){var f=this,d=f.groupCache,b=!f.isExpanded(j),c;if(f.collapsible){if(i.ctrlKey){Ext.suspendLayouts();for(c in d){if(c===j){if(b){f.expand(j)}}else{f.doCollapseExpand(true,c,false)}}Ext.resumeLayouts(true);return}if(b){f.expand(j)}else{f.collapse(j)}}},setupRowData:function(h,k,m){var i=this,e=i.refreshData,b=i.groupInfo,g=e.header,c=e.groupField,j=i.view.dataSource,a,l,d,f;m.isCollapsedGroup=false;m.summaryRecord=null;if(e.doGrouping){a=i.view.store.groupers.first();if(h.children){l=a.getGroupString(h.children[0]);m.isFirstRow=m.isLastRow=true;m.itemClasses.push(i.hdCollapsedCls);m.isCollapsedGroup=true;m.groupInfo=b;b.groupField=c;b.name=l;b.groupValue=h.children[0].get(c);b.columnName=g?g.text:c;m.collapsibleCls=i.collapsible?i.collapsibleCls:i.hdNotCollapsibleCls;m.groupId=i.createGroupId(l);b.rows=b.children=h.children;if(i.showSummaryRow){m.summaryRecord=e.summaryData[l]}return}l=a.getGroupString(h);m.isFirstRow=k===0;if(!m.isFirstRow){d=j.getAt(k-1);if(d){m.isFirstRow=!d.isEqual(a.getGroupString(d),l)}}m.isLastRow=k==j.getTotalCount()-1;if(!m.isLastRow){f=j.getAt(k+1);if(f){m.isLastRow=!f.isEqual(a.getGroupString(f),l)}}if(m.isFirstRow){b.groupField=c;b.name=l;b.groupValue=h.get(c);b.columnName=g?g.text:c;m.collapsibleCls=i.collapsible?i.collapsibleCls:i.hdNotCollapsibleCls;m.groupId=i.createGroupId(l);if(!i.isExpanded(l)){m.itemClasses.push(i.hdCollapsedCls);m.isCollapsedGroup=true}if(j.buffered){b.rows=b.children=[]}else{b.rows=b.children=i.getRecordGroup(h).children}m.groupInfo=b}if(m.isLastRow){if(i.showSummaryRow){m.summaryRecord=e.summaryData[l]}}}},setup:function(d,e){var b=this,c=b.refreshData,a=!b.disabled&&b.view.store.isGrouped();b.skippedRows=0;if(e.view.bufferedRenderer){e.view.bufferedRenderer.variableRowHeight=true}c.groupField=b.getGroupField();c.header=b.getGroupedHeader(c.groupField);c.doGrouping=a;e.groupHeaderTpl=Ext.XTemplate.getTpl(b,"groupHeaderTpl");if(a&&b.showSummaryRow){c.summaryData=b.generateSummaryData()}},cleanup:function(b,c){var a=this.refreshData;c.groupInfo=c.groupHeaderTpl=c.isFirstRow=null;a.groupField=a.header=null},getGroupName:function(b){var d=this,a=d.view,c=d.eventSelector,e,g,f;g=Ext.fly(b).findParent(c);if(!g){f=Ext.fly(b).findParent(a.itemSelector);if(f){g=f.down(c,true)}}if(g){e=g.id.split(a.id+"-hd-");if(e.length===2){return Ext.htmlDecode(e[1])}}},getRecordGroup:function(a){var b=this.view.store.groupers.first();if(b){return this.groupCache[b.getGroupString(a)]}},createGroupId:function(a){return this.view.id+"-hd-"+Ext.htmlEncode(a)},createGroupCls:function(a){return this.view.id+"-"+Ext.htmlEncode(a)+"-item"},getGroupField:function(){return this.view.store.getGroupField()},getGroupedHeader:function(b){var d=this,e=d.view.headerCt,c=d.lockingPartner,a,f;b=b||this.getGroupField();if(b){a="[dataIndex="+b+"]";f=e.down(a);if(!f&&c){f=c.view.headerCt.down(a)}}return f||null},getFireEventArgs:function(b,a,d,c){return[b,a,d,this.getGroupName(d),c]},destroy:function(){var a=this,b=a.dataSource;a.view=a.prunedHeader=a.grid=a.groupCache=a.dataSource=null;a.callParent();if(b){b.bindStore(null)}},onReconfigure:function(d,a,c,f,b){var e=d;if(a&&a!==f){if(a.buffered!==f.buffered){Ext.Error.raise("Cannot reconfigure grouping switching between buffered and non-buffered stores")}if(a.buffered){e.bindStore(a);e.dataSource.processStore(a)}}}});