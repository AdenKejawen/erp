Ext.define("Ext.grid.feature.Grouping",{extend:"Ext.grid.feature.Feature",mixins:{summary:"Ext.grid.feature.AbstractSummary"},requires:["Ext.grid.feature.GroupStore"],alias:"feature.grouping",eventPrefix:"group",groupCls:Ext.baseCSSPrefix+"grid-group-hd",eventSelector:"."+Ext.baseCSSPrefix+"grid-group-hd",refreshData:{},groupInfo:{},wrapsItem:true,groupHeaderTpl:"{columnName}: {name}",depthToIndent:17,collapsedCls:Ext.baseCSSPrefix+"grid-group-collapsed",hdCollapsedCls:Ext.baseCSSPrefix+"grid-group-hd-collapsed",hdNotCollapsibleCls:Ext.baseCSSPrefix+"grid-group-hd-not-collapsible",collapsibleCls:Ext.baseCSSPrefix+"grid-group-hd-collapsible",ctCls:Ext.baseCSSPrefix+"group-hd-container",groupByText:"Group by this field",showGroupsText:"Show in groups",hideGroupedHeader:false,startCollapsed:false,enableGroupingMenu:true,enableNoGroups:true,collapsible:true,expandTip:"Click to expand. CTRL key collapses all others",collapseTip:"Click to collapse. CTRL/click collapses all others",showSummaryRow:false,tableTpl:{before:function(a){if(a.rows.length===1&&a.rows[0].isSummary){return}this.groupingFeature.setup(a.rows,a.view.rowValues)},after:function(a){if(a.rows.length===1&&a.rows[0].isSummary){return}this.groupingFeature.cleanup(a.rows,a.view.rowValues)},priority:200},groupTpl:["{%","var me = this.groupingFeature;","me.setupRowData(values.record, values.recordIndex, values);","values.needsWrap = values.isFirstRow || values.summaryRecord;","values.recordIndex += me.skippedRows;","%}",'<tpl if="needsWrap">','<tr data-boundView="{view.id}" data-recordId="{record.internalId}" data-recordIndex="{[values.isCollapsedGroup ? -1 : values.recordIndex]}" class="{[values.itemClasses.join(" ")]} '+Ext.baseCSSPrefix+'grid-wrap-row">','<td class="'+Ext.baseCSSPrefix+'group-hd-container" colspan="{columns.length}">','<tpl if="isFirstRow">',"{%",'var groupTitleStyle = (!values.view.lockingPartner || (values.view.ownerCt === values.view.ownerCt.ownerLockable.lockedGrid) || (values.view.lockingPartner.headerCt.getVisibleGridColumns().length === 0)) ? "" : "visibility:hidden";',"%}",'<div id="{groupId}" class="'+Ext.baseCSSPrefix+'grid-group-hd {collapsibleCls}" tabIndex="0">','<div class="'+Ext.baseCSSPrefix+'grid-group-title" style="{[groupTitleStyle]}">',"{%values.groupHeaderTpl.applyOut(values.groupInfo, out, parent);%}","</div>","</div>","</tpl>",'<tpl if="summaryRecord || !isCollapsedGroup">','<table class="'+Ext.baseCSSPrefix+"{view.id}-table "+Ext.baseCSSPrefix+'grid-table" border="0" cellspacing="0" cellpadding="0" style="width:100%">',"{[values.view.renderColumnSizer(out)]}",'<tpl if="!isCollapsedGroup">',"{%","values.itemClasses.length = 0;","this.nextTpl.applyOut(values, out, parent);","%}","</tpl>",'<tpl if="summaryRecord">',"{%me.outputSummaryRecord(values.summaryRecord, values, out);%}","</tpl>","</table>","</tpl>","</td>","</tr>","{%","if (values.isCollapsedGroup) {","me.skippedRows += me.getRecordGroup(values.record).children.length - 1;","}","%}","<tpl else>","{%this.nextTpl.applyOut(values, out, parent);%}","</tpl>",{priority:200,syncRowHeights:function(d,i){d=Ext.fly(d,"syncDest");i=Ext.fly(i,"sycSrc");var b=this.owner,e=d.down(b.eventSelector,true),f,g=d.down(b.summaryRowSelector,true),c,a,h;if(e&&(f=i.down(b.eventSelector,true))){e.style.height=f.style.height="";if((a=e.offsetHeight)>(h=f.offsetHeight)){Ext.fly(f).setHeight(a)}else{if(h>a){Ext.fly(e).setHeight(h)}}}if(g&&(c=i.down(b.summaryRowSelector,true))){g.style.height=c.style.height="";if((a=g.offsetHeight)>(h=c.offsetHeight)){Ext.fly(c).setHeight(a)}else{if(h>a){Ext.fly(g).setHeight(h)}}}},syncContent:function(b,g){b=Ext.fly(b,"syncDest");g=Ext.fly(g,"sycSrc");var a=this.owner,d=b.down(a.eventSelector,true),c=g.down(a.eventSelector,true),f=b.down(a.summaryRowSelector,true),e=g.down(a.summaryRowSelector,true);if(d&&c){Ext.fly(d).syncContent(c)}if(f&&e){Ext.fly(f).syncContent(e)}}}],constructor:function(){this.groupCache={};this.callParent(arguments)},init:function(b){var c=this,a=c.view;c.mixins.summary.init.call(c);c.callParent(arguments);a.headerCt.on({columnhide:c.onColumnHideShow,columnshow:c.onColumnHideShow,scope:c});a.addTableTpl(c.tableTpl).groupingFeature=c;a.addRowTpl(Ext.XTemplate.getTpl(c,"groupTpl")).groupingFeature=c;a.preserveScrollOnRefresh=true;if(a.store.buffered){c.collapsible=false}else{c.dataSource=a.dataSource=new Ext.grid.feature.GroupStore(c,a.store);c.startCollapsed=false}c.grid.on({reconfigure:c.onReconfigure});a.on({afterrender:c.afterViewRender,scope:c,single:true})},vetoEvent:function(a,c,d,b){if(b.getTarget(this.eventSelector)){return false}},enable:function(){var c=this,a=c.view,b=a.store,d;c.lastGroupField=c.getGroupField();if(c.lastGroupIndex){c.block();b.group(c.lastGroupIndex);c.unblock()}c.callParent();d=c.view.headerCt.getMenu().down("#groupToggleMenuItem");if(d){d.setChecked(true,true)}c.refreshIf()},disable:function(){var d=this,a=d.view,b=a.store,e,c;c=b.groupers.first();if(c){d.lastGroupIndex=c.property;d.block();b.clearGrouping();d.unblock()}d.callParent();e=d.view.headerCt.getMenu().down("#groupToggleMenuItem");if(e){e.setChecked(false,true)}d.refreshIf()},refreshIf:function(){var b=this.grid.ownerCt,a=this.view;if(!a.store.remoteGroup&&!this.blockRefresh){if(b&&b.lockable){b.view.refresh()}else{a.refresh()}}},destroy:function(){delete this.view;delete this.prunedHeader},afterViewRender:function(){var b=this,a=b.view;a.on({scope:b,groupclick:b.onGroupClick});if(b.enableGroupingMenu){b.injectGroupingMenu()}b.pruneGroupedHeader();b.lastGroupField=b.getGroupField();b.block();b.onGroupChange();b.unblock()},injectGroupingMenu:function(){var a=this,b=a.view.headerCt;b.showMenuBy=a.showMenuBy;b.getMenuItems=a.getMenuItems()},onColumnHideShow:function(d,g){var k=this.view,b=k.headerCt,a=b.getMenu(),f=a.down("#groupMenuItem"),c=b.getGridColumns(true).length,j,h,e;if(g!==this.prunedHeader){if(f){if(c>1){f.enable()}else{f.disable()}}}j=k.el.query("."+this.ctCls);for(e=0,h=j.length;e<h;++e){j[e].colSpan=c}},showMenuBy:function(b,g){var f=this.getMenu(),c=f.down("#groupMenuItem"),a=g.groupable===false?"disable":"enable",e=f.down("#groupToggleMenuItem"),d=this.view.store.isGrouped();c[a]();if(e){e.setChecked(d,true);e[d?"enable":"disable"]()}Ext.grid.header.Container.prototype.showMenuBy.apply(this,arguments)},getMenuItems:function(){var f=this,c=f.groupByText,e=f.disabled||!f.getGroupField(),a=f.showGroupsText,d=f.enableNoGroups,b=f.view.headerCt.getMenuItems;return function(){var g=b.call(this);g.push("-",{iconCls:Ext.baseCSSPrefix+"group-by-icon",itemId:"groupMenuItem",text:c,handler:f.onGroupMenuItemClick,scope:f});if(d){g.push({itemId:"groupToggleMenuItem",text:a,checked:!e,checkHandler:f.onGroupToggleMenuItemClick,scope:f})}return g}},onGroupMenuItemClick:function(c,f){var d=this,g=c.parentMenu,h=g.activeHeader,a=d.view,b=a.store;delete d.lastGroupIndex;d.block();d.enable();b.group(h.dataIndex);d.pruneGroupedHeader();d.unblock();d.refreshIf()},block:function(){this.blockRefresh=this.view.blockRefresh=true},unblock:function(){this.blockRefresh=this.view.blockRefresh=false},onGroupToggleMenuItemClick:function(a,b){this[b?"enable":"disable"]()},pruneGroupedHeader:function(){var a=this,b=a.getGroupedHeader();if(a.hideGroupedHeader&&b){Ext.suspendLayouts();if(a.prunedHeader&&a.prunedHeader!==b){a.prunedHeader.show()}a.prunedHeader=b;b.hide();Ext.resumeLayouts(true)}},getHeaderNode:function(a){return Ext.get(this.createGroupId(a))},getGroup:function(b){var a=this.groupCache,c=a[b];if(!c){c=a[b]={isCollapsed:false}}return c},isExpanded:function(a){return !this.getGroup(a).isCollapsed},expand:function(b,a){this.doCollapseExpand(false,b,a)},expandAll:function(){var d=this,a=d.view,c=d.groupCache,e,b=d.lockingPartner;for(e in c){if(c.hasOwnProperty(e)){c[e].isCollapsed=false}}Ext.suspendLayouts();a.suspendEvent("beforerefresh","refresh");d.dataSource.onRefresh();a.resumeEvent("beforerefresh","refresh");if(b){b.expandAll()}Ext.resumeLayouts(true);for(e in c){if(c.hasOwnProperty(e)){a.fireEvent("groupexpand",a,Ext.get(this.getHeaderNode(e)),e)}}},collapse:function(b,a){this.doCollapseExpand(true,b,a)},collapseAll:function(){var d=this,a=d.view,c=d.groupCache,e,b=d.lockingPartner;for(e in c){if(c.hasOwnProperty(e)){c[e].isCollapsed=true}}Ext.suspendLayouts();a.suspendEvent("beforerefresh","refresh");d.dataSource.onRefresh();a.resumeEvent("beforerefresh","refresh");if(b){b.collapseAll()}Ext.resumeLayouts(true);for(e in c){if(c.hasOwnProperty(e)){a.fireEvent("groupcollapse",a,Ext.get(this.getHeaderNode(e)),e)}}},doCollapseExpand:function(e,g,b){var d=this,a=d.view,c=d.lockingPartner,f;if(d.groupCache[g].isCollapsed!=e){d.groupCache[g].isCollapsed=e;Ext.suspendLayouts();d.dataSource.onRefresh();f=Ext.get(this.getHeaderNode(g));a.fireEvent(e?"groupcollapse":"groupexpand",a,f,g);if(c){c.doCollapseExpand(e,g,b)}Ext.resumeLayouts(true);if(b){f.up(a.getItemSelector()).scrollIntoView(a.el,null,true)}}},onGroupChange:function(){var d=this,e=d.getGroupField(),c,a,b;if(d.hideGroupedHeader){if(d.lastGroupField){c=d.getMenuItem(d.lastGroupField);if(c){c.setChecked(true)}}if(e){a=d.view.headerCt.getVisibleGridColumns();b=((a.length===1)&&(a[0].dataIndex==e));c=d.getMenuItem(e);if(c&&!b){c.setChecked(false)}}}d.refreshIf();d.lastGroupField=e},getMenuItem:function(b){var a=this.view,d=a.headerCt.down("gridcolumn[dataIndex="+b+"]"),c=a.headerCt.getMenu();return d?c.down("menuitem[headerId="+d.id+"]"):null},onGroupKey:function(c,b){var a=this,d=a.getGroupName(b.target);if(d){a.onGroupClick(a.view,b.target,d,b)}},onGroupClick:function(a,h,j,i){var f=this,d=f.groupCache,b=!f.isExpanded(j),c;if(f.collapsible){if(i.ctrlKey){Ext.suspendLayouts();for(c in d){if(c===j){if(b){f.expand(j)}}else{f.doCollapseExpand(true,c,false)}}Ext.resumeLayouts(true);return}if(b){f.expand(j)}else{f.collapse(j)}}},setupRowData:function(h,k,m){var i=this,e=i.refreshData,a=i.groupInfo,g=e.header,b=e.groupField,d=i.groupCache,j=i.view.dataSource,l,c,f;m.isCollapsedGroup=false;m.summaryRecord=null;if(e.doGrouping){l=h.get(b);m.isFirstRow=k===0;if(!m.isFirstRow){c=j.getAt(k-1);if(c){m.isFirstRow=c.get(b)!==l}}m.isLastRow=k==j.getTotalCount()-1;if(!m.isLastRow){f=j.getAt(k+1);if(f){m.isLastRow=f.get(b)!==l}}if(m.isFirstRow){a.groupField=b;a.name=l;a.groupValue=l;a.columnName=g?g.text:b;m.collapsibleCls=i.collapsible?i.collapsibleCls:i.hdNotCollapsibleCls;m.groupId=i.createGroupId(l);if(!i.isExpanded(l)){m.itemClasses.push(i.hdCollapsedCls);m.isCollapsedGroup=true}if(j.buffered){a.rows=a.children=[]}else{a.rows=a.children=i.getRecordGroup(h).children}m.groupInfo=a}if(m.isLastRow){if(i.showSummaryRow){m.summaryRecord=e.summaryData[l]}}}},setup:function(c,d){var a=this,b=a.refreshData;a.skippedRows=0;if(d.view.bufferedRenderer){d.view.bufferedRenderer.variableRowHeight=true}b.groupField=a.getGroupField();b.header=a.getGroupedHeader(b.groupField);b.doGrouping=!a.disabled&&a.view.store.isGrouped();d.groupHeaderTpl=Ext.XTemplate.getTpl(a,"groupHeaderTpl");if(a.showSummaryRow){b.summaryData=a.generateSummaryData()}},cleanup:function(b,c){var a=this.refreshData;c.groupInfo=c.groupHeaderTpl=c.isFirstRow=null;a.groupField=a.header=null},getGroupName:function(b){var d=this,a=d.view,c=d.eventSelector,e,g,f;g=Ext.fly(b).findParent(c);if(!g){f=Ext.fly(b).findParent(a.itemSelector);if(f){g=f.down(c,true)}}if(g){e=g.id.split(a.id+"-hd-");if(e.length===2){return Ext.htmlDecode(e[1])}}},getRecordGroup:function(b){var a=this.getGroupField();if(a){return this.groupCache[b.get(a)]}},createGroupId:function(a){return this.view.id+"-hd-"+Ext.htmlEncode(a)},createGroupCls:function(a){return this.view.id+"-"+Ext.htmlEncode(a)+"-item"},getGroupField:function(){return this.view.store.getGroupField()},getGroupedHeader:function(a){var b=this.view.headerCt;a=a||this.getGroupField();return a?b.down("[dataIndex="+a+"]"):null},getFireEventArgs:function(b,a,d,c){return[b,a,d,this.getGroupName(d),c]},onReconfigure:function(d,a,c,f,b){var e=d;if(a!==f){if(a.buffered!==f.buffered){Ext.Error.raise("Cannot reconfigure grouping switching between buffered and non-buffered stores")}if(a.buffered){e.bindStore(a);e.dataSource.processStore(a)}}}});